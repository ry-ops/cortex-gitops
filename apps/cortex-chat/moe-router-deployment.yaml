apiVersion: v1
kind: ConfigMap
metadata:
  name: moe-router-config
  namespace: cortex-chat
data:
  config.yaml: |
    # MoE Router Configuration
    router:
      port: 8080
      experts:
        - name: general
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 1.0
          specialization: "general conversation and task routing"
        - name: infrastructure
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 2.0
          specialization: "kubernetes, deployment, infrastructure management"
        - name: security
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 2.0
          specialization: "security scanning, vulnerability analysis, compliance"
        - name: automation
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 1.5
          specialization: "workflow automation, n8n, langflow"

    qdrant:
      host: qdrant.cortex-chat.svc.cluster.local
      port: 6333
      collection: chat_memory

    telemetry:
      enabled: true
      redis_host: redis.cortex-system.svc.cluster.local
      redis_port: 6379
      redis_key_prefix: "moe:telemetry:"
  chat-router.py: |
    #!/usr/bin/env python3
    """
    MoE Chat Router - Routes to cortex-orchestrator with MCP server access
    Provides infrastructure management capabilities
    """
    import os
    import json
    import logging
    import requests
    from flask import Flask, request, jsonify
    from anthropic import Anthropic
    from datetime import datetime

    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    logger = logging.getLogger(__name__)

    app = Flask(__name__)

    # Initialize Anthropic client for intent classification
    anthropic_client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

    # Expert configuration - all route to cortex-orchestrator
    ORCHESTRATOR_URL = os.getenv('ORCHESTRATOR_URL', 'http://cortex-orchestrator.cortex-system.svc.cluster.local:8080')

    # Simple in-memory conversation storage
    conversations = {}

    @app.route('/health', methods=['GET'])
    def health():
        return jsonify({"status": "healthy", "service": "moe-chat-router"}), 200

    @app.route('/api/auth/login', methods=['POST'])
    def login():
        """Auth endpoint"""
        data = request.json or {}
        username = data.get('username', 'user')
        return jsonify({
            "success": True,
            "token": "mock-token-123",
            "username": username,
            "user": {"username": username, "id": "user-1"}
        }), 200

    @app.route('/api/conversations', methods=['GET'])
    def get_conversations():
        """Get all conversations"""
        conv_list = [
            {
                "id": conv_id,
                "title": f"Conversation {conv_id[:30]}..." if len(conv_id) > 30 else f"Conversation {conv_id}",
                "lastMessage": msgs[-1]["content"] if msgs else "No messages",
                "timestamp": "2026-01-19T00:00:00Z",
                "messageCount": len(msgs)
            }
            for conv_id, msgs in conversations.items()
        ]
        return jsonify(conv_list), 200

    @app.route('/api/conversations', methods=['POST'])
    def create_conversation():
        """Create new conversation"""
        conv_id = f"conv-{len(conversations) + 1}"
        conversations[conv_id] = []
        return jsonify({"id": conv_id, "title": f"New Conversation {conv_id}"}), 201

    @app.route('/api/chat', methods=['POST'])
    def chat():
        """Main chat endpoint - routes to cortex-orchestrator"""
        try:
            data = request.json
            message = data.get('message', '')
            conversation_id = data.get('sessionId', 'default')

            logger.info(f"Chat request: conversation={conversation_id}, message={message[:50]}...")

            # Store user message
            if conversation_id not in conversations:
                conversations[conversation_id] = []
            conversations[conversation_id].append({
                "role": "user",
                "content": message
            })

            # Classify intent
            intent_prompt = f"""Classify this user message into one of these categories:
            - infrastructure: Kubernetes, pods, deployments, nodes, services
            - security: Sandfly alerts, vulnerabilities, security events
            - automation: n8n workflows, task automation
            - general: Everything else

            User message: {message}

            Respond with just the category name."""

            try:
                intent_response = anthropic_client.messages.create(
                    model="claude-haiku-4-20250514",
                    max_tokens=10,
                    messages=[{"role": "user", "content": intent_prompt}]
                )
                expert = intent_response.content[0].text.strip().lower()
                if expert not in ['infrastructure', 'security', 'automation', 'general']:
                    expert = 'general'
            except Exception as e:
                logger.error(f"Intent classification error: {e}")
                expert = 'general'

            logger.info(f"Classified as: {expert}")

            # Route to cortex-orchestrator
            try:
                orch_request = {
                    "message": message,
                    "conversation_id": conversation_id,
                    "expert": expert,
                    "history": conversations[conversation_id][:-1]  # Exclude the message we just added
                }

                response = requests.post(
                    f"{ORCHESTRATOR_URL}/chat",
                    json=orch_request,
                    timeout=60
                )

                if response.status_code == 200:
                    assistant_message = response.json().get('response', 'No response from orchestrator')
                else:
                    logger.error(f"Orchestrator returned {response.status_code}: {response.text}")
                    assistant_message = f"The orchestrator is currently unavailable. Status: {response.status_code}"

            except requests.exceptions.Timeout:
                logger.error("Orchestrator timeout")
                assistant_message = "The request timed out. Please try again."
            except Exception as e:
                logger.error(f"Orchestrator routing error: {e}")
                assistant_message = f"Error routing to expert: {str(e)}"

            # Store assistant response
            conversations[conversation_id].append({
                "role": "assistant",
                "content": assistant_message
            })

            return jsonify({
                "response": assistant_message,
                "conversation_id": conversation_id,
                "expert": expert,
                "timestamp": datetime.utcnow().isoformat()
            }), 200

        except Exception as e:
            logger.error(f"Chat error: {e}")
            return jsonify({"error": str(e)}), 500

    @app.route('/api/conversations/<conversation_id>', methods=['GET'])
    def get_conversation(conversation_id):
        """Get conversation with messages"""
        if conversation_id not in conversations:
            conversations[conversation_id] = []

        messages = [
            {
                "role": msg["role"],
                "content": msg["content"],
                "timestamp": "2026-01-19T00:00:00Z"
            }
            for msg in conversations[conversation_id]
        ]

        return jsonify({
            "conversation": {
                "id": conversation_id,
                "title": f"Conversation {conversation_id[:30]}..." if len(conversation_id) > 30 else f"Conversation {conversation_id}",
                "timestamp": "2026-01-19T00:00:00Z",
                "messageCount": len(messages),
                "messages": messages
            }
        }), 200

    @app.route('/api/conversations/<conversation_id>/messages', methods=['GET'])
    def get_messages(conversation_id):
        """Get conversation history"""
        if conversation_id not in conversations:
            return jsonify([]), 200

        messages = [
            {
                "role": msg["role"],
                "content": msg["content"],
                "timestamp": "2026-01-19T00:00:00Z"
            }
            for msg in conversations[conversation_id]
        ]
        return jsonify(messages), 200

    if __name__ == '__main__':
        logger.info(f"Starting MoE Chat Router - routing to {ORCHESTRATOR_URL}")
        app.run(host='0.0.0.0', port=8080, debug=True)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moe-router
  namespace: cortex-chat
  labels:
    app: moe-router
spec:
  replicas: 1
  selector:
    matchLabels:
      app: moe-router
  template:
    metadata:
      labels:
        app: moe-router
    spec:
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: moe-router
        image: 10.43.170.72:5000/moe-router:latest
        command: ["python", "simple-chat-api.py"]
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        env:
        - name: CONFIG_PATH
          value: /config/config.yaml
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: cortex-chat-secrets
              key: anthropic-api-key
        volumeMounts:
        - name: config
          mountPath: /config
        - name: code-fix
          mountPath: /app/simple-chat-api.py
          subPath: simple-chat-api.py
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
      volumes:
      - name: config
        configMap:
          name: moe-router-config
      - name: code-fix
        configMap:
          name: moe-router-config
---
apiVersion: v1
kind: Service
metadata:
  name: moe-router
  namespace: cortex-chat
  labels:
    app: moe-router
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: moe-router
