apiVersion: v1
kind: ConfigMap
metadata:
  name: moe-router-config
  namespace: cortex-chat
data:
  config.yaml: |
    # MoE Router Configuration
    router:
      port: 8080
      experts:
        - name: general
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 1.0
          specialization: "general conversation and task routing"
        - name: infrastructure
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 2.0
          specialization: "kubernetes, deployment, infrastructure management"
        - name: security
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 2.0
          specialization: "security scanning, vulnerability analysis, compliance"
        - name: automation
          endpoint: http://cortex-orchestrator.cortex.svc.cluster.local:8000
          weight: 1.5
          specialization: "workflow automation, n8n, langflow"

    qdrant:
      host: qdrant.cortex-chat.svc.cluster.local
      port: 6333
      collection: chat_memory

    telemetry:
      enabled: true
      redis_host: redis.cortex-system.svc.cluster.local
      redis_port: 6379
      redis_key_prefix: "moe:telemetry:"
  simple-chat-api.py: |
    #!/usr/bin/env python3
    """
    Simple Chat API for local development
    Minimal MoE router without Qdrant/Redis dependencies
    """
    import os
    import json
    import logging
    from flask import Flask, request, jsonify
    from flask_cors import CORS
    from anthropic import Anthropic

    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    logger = logging.getLogger(__name__)

    app = Flask(__name__)
    CORS(app)  # Enable CORS for frontend access

    # Initialize Anthropic client
    api_key = os.getenv('ANTHROPIC_API_KEY')
    if not api_key:
        logger.warning("ANTHROPIC_API_KEY not set - chat will return mock responses")
        anthropic_client = None
    else:
        anthropic_client = Anthropic(api_key=api_key)

    # Simple in-memory conversation storage
    conversations = {}

    @app.route('/health', methods=['GET'])
    def health():
        return jsonify({
            "status": "healthy",
            "service": "simple-chat-api",
            "anthropic_configured": anthropic_client is not None
        }), 200

    @app.route('/api/auth/login', methods=['POST'])
    def login():
        """Simple auth endpoint for frontend"""
        data = request.json or {}
        username = data.get('username', 'user')

        # Mock authentication - always succeed
        return jsonify({
            "success": True,
            "token": "mock-token-123",
            "username": username,
            "user": {
                "username": username,
                "id": "user-1"
            }
        }), 200

    @app.route('/api/conversations', methods=['GET'])
    def get_conversations():
        """Get all conversations"""
        conv_list = [
            {
                "id": conv_id,
                "title": f"Conversation {conv_id}",
                "lastMessage": msgs[-1] if msgs else "No messages",
                "timestamp": "2026-01-19T00:00:00Z"
            }
            for conv_id, msgs in conversations.items()
        ]
        return jsonify(conv_list), 200

    @app.route('/api/conversations', methods=['POST'])
    def create_conversation():
        """Create new conversation"""
        conv_id = f"conv-{len(conversations) + 1}"
        conversations[conv_id] = []
        return jsonify({"id": conv_id, "title": f"New Conversation {conv_id}"}), 201

    @app.route('/api/chat', methods=['POST'])
    def chat():
        """Main chat endpoint"""
        try:
            data = request.json
            message = data.get('message', '')
            conversation_id = data.get('conversation_id', 'default')

            logger.info(f"Chat request: conversation={conversation_id}, message={message[:50]}...")

            # Store user message
            if conversation_id not in conversations:
                conversations[conversation_id] = []
            conversations[conversation_id].append({
                "role": "user",
                "content": message
            })

            # Generate response
            if anthropic_client:
                try:
                    # Use Claude for response
                    response = anthropic_client.messages.create(
                        model="claude-sonnet-4-20250514",
                        max_tokens=1024,
                        messages=conversations[conversation_id]
                    )

                    assistant_message = response.content[0].text

                except Exception as e:
                    logger.error(f"Anthropic API error: {e}")
                    assistant_message = f"I'm having trouble connecting to Claude right now. Error: {str(e)}"
            else:
                # Mock response without API key
                assistant_message = f"Echo: {message} (Note: Set ANTHROPIC_API_KEY for real Claude responses)"

            # Store assistant response
            conversations[conversation_id].append({
                "role": "assistant",
                "content": assistant_message
            })

            return jsonify({
                "response": assistant_message,
                "conversation_id": conversation_id,
                "expert": "general",
                "timestamp": "2026-01-19T00:00:00Z"
            }), 200

        except Exception as e:
            logger.error(f"Chat error: {e}")
            return jsonify({"error": str(e)}), 500

    @app.route('/api/conversations/<conversation_id>/messages', methods=['GET'])
    def get_messages(conversation_id):
        """Get conversation history"""
        if conversation_id not in conversations:
            return jsonify([]), 200

        messages = [
            {
                "role": msg["role"],
                "content": msg["content"],
                "timestamp": "2026-01-19T00:00:00Z"
            }
            for msg in conversations[conversation_id]
        ]
        return jsonify(messages), 200

    if __name__ == '__main__':
        logger.info("Starting Simple Chat API on http://localhost:8080")
        logger.info(f"Anthropic API configured: {anthropic_client is not None}")
        app.run(host='0.0.0.0', port=8080, debug=True)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moe-router
  namespace: cortex-chat
  labels:
    app: moe-router
spec:
  replicas: 1
  selector:
    matchLabels:
      app: moe-router
  template:
    metadata:
      labels:
        app: moe-router
    spec:
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: moe-router
        image: 10.43.170.72:5000/moe-router:latest
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        env:
        - name: CONFIG_PATH
          value: /config/config.yaml
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: cortex-chat-secrets
              key: anthropic-api-key
        volumeMounts:
        - name: config
          mountPath: /config
        - name: code-fix
          mountPath: /app/simple-chat-api.py
          subPath: simple-chat-api.py
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
      volumes:
      - name: config
        configMap:
          name: moe-router-config
      - name: code-fix
        configMap:
          name: moe-router-config
---
apiVersion: v1
kind: Service
metadata:
  name: moe-router
  namespace: cortex-chat
  labels:
    app: moe-router
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: moe-router
