apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-html
  namespace: cortex-chat
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="theme-color" content="#F5F0E8">
        <title>Cortex Chat</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            :root {
                /* Light Theme (Default - Claude iOS inspired) */
                --bg-primary: #F5F0E8;
                --bg-secondary: #FFFFFF;
                --bg-tertiary: #EEEBE4;
                --bg-input: #FFFFFF;
                --text-primary: #1A1A1A;
                --text-secondary: #6B6B6B;
                --text-tertiary: #9B9B9B;
                --border-subtle: #E0DDD5;
                --border-medium: #D0CDC5;
                --accent-orange: #D97757;
                --accent-blue: #5B8FD9;
                --accent-green: #4CAF50;
                --error-red: #D9695F;
                --shadow-light: rgba(0, 0, 0, 0.05);
                --shadow-medium: rgba(0, 0, 0, 0.1);
                --shadow-heavy: rgba(0, 0, 0, 0.15);
                --header-height: 60px;
                --sidebar-width: 280px;
            }
    
            /* Dark Theme */
            [data-theme="dark"] {
                --bg-primary: #1A1A1A;
                --bg-secondary: #2D2D2D;
                --bg-tertiary: #3A3A3A;
                --bg-input: #2D2D2D;
                --text-primary: #EEEEEE;
                --text-secondary: #B0B0B0;
                --text-tertiary: #7A7A7A;
                --border-subtle: #3A3A3A;
                --border-medium: #4A4A4A;
                --shadow-light: rgba(0, 0, 0, 0.2);
                --shadow-medium: rgba(0, 0, 0, 0.3);
                --shadow-heavy: rgba(0, 0, 0, 0.4);
            }
    
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                overflow: hidden;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
    
            /* Login Screen */
            #login-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-primary);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            }
    
            #login-screen.active {
                display: flex;
            }
    
            .login-container {
                background: var(--bg-secondary);
                border-radius: 16px;
                padding: 48px 40px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 4px 24px var(--shadow-medium);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 24px;
            }
    
            .login-logo {
                width: 64px;
                height: 64px;
            }
    
            .login-title {
                font-size: 28px;
                font-weight: 600;
                color: var(--text-primary);
                margin: 0;
                text-align: center;
            }

            .login-subtitle {
                font-size: 15px;
                color: var(--text-primary);
                opacity: 0.8;
                margin: 8px 0 0 0;
                text-align: center;
            }
    
            .login-form {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
    
            .login-input-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
    
            .login-label {
                font-size: 13px;
                font-weight: 500;
                color: var(--text-secondary);
            }
    
            .login-input {
                background: var(--bg-tertiary);
                border: 1px solid var(--border-subtle);
                border-radius: 10px;
                padding: 12px 16px;
                font-size: 15px;
                color: var(--text-primary);
                transition: all 0.2s;
            }
    
            .login-input:focus {
                outline: none;
                border-color: var(--accent-orange);
                box-shadow: 0 0 0 3px rgba(217, 119, 87, 0.1);
            }
    
            .login-btn {
                background: var(--accent-orange);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 14px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                margin-top: 8px;
            }
    
            .login-btn:hover {
                background: #c96646;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(217, 119, 87, 0.3);
            }
    
            .login-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }
    
            .login-error {
                background: rgba(217, 105, 95, 0.1);
                border: 1px solid var(--error-red);
                color: var(--error-red);
                padding: 12px;
                border-radius: 8px;
                font-size: 13px;
                text-align: center;
                display: none;
            }
    
            .login-error.show {
                display: block;
            }
    
            /* Main App Layout */
            .app-container {
                display: none;
                height: 100vh;
                width: 100vw;
                position: fixed;
                top: 0;
                left: 0;
            }
    
            .app-container.authenticated {
                display: flex;
                flex-direction: column;
            }
    
            /* Header */
            .app-header {
                height: var(--header-height);
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-subtle);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 16px;
                z-index: 100;
                box-shadow: 0 1px 3px var(--shadow-light);
            }
    
            .header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }
    
            .hamburger-btn {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                border: none;
                background: transparent;
                color: var(--text-primary);
                font-size: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
            }
    
            .hamburger-btn:hover {
                background: var(--bg-tertiary);
            }
    
            .header-logo {
                font-size: 20px;
                font-weight: 600;
                color: var(--accent-orange);
                display: flex;
                align-items: center;
                gap: 8px;
            }
    
            .header-right {
                display: flex;
                align-items: center;
                gap: 12px;
            }
    
            .theme-toggle-btn {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
            }
    
            .theme-toggle-btn:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
    
            .profile-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: var(--accent-orange);
                color: white;
                border: none;
                font-size: 16px;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
            }
    
            .profile-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(217, 119, 87, 0.3);
            }
    
            /* Main Content Area */
            .content-wrapper {
                display: flex;
                flex: 1;
                overflow: hidden;
            }
    
            /* Sidebar */
            .sidebar {
                width: var(--sidebar-width);
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-subtle);
                display: flex;
                flex-direction: column;
                transition: transform 0.3s ease;
                z-index: 90;
            }
    
            .sidebar-section {
                border-bottom: 1px solid var(--border-subtle);
            }
    
            .sidebar-section-header {
                padding: 16px 20px 8px;
                font-size: 13px;
                font-weight: 600;
                color: var(--text-tertiary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
    
            .new-chat-btn {
                margin: 12px 16px;
                background: var(--accent-orange);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 12px 16px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s;
            }
    
            .new-chat-btn:hover {
                background: #c96646;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(217, 119, 87, 0.2);
            }
    
            .sidebar-nav {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
            }
    
            .nav-item {
                padding: 12px 20px;
                color: var(--text-secondary);
                font-size: 15px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.15s;
            }
    
            .nav-item:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
    
            .nav-item.active {
                background: var(--bg-tertiary);
                color: var(--accent-orange);
                font-weight: 500;
            }
    
            .nav-icon {
                font-size: 18px;
                width: 24px;
                text-align: center;
            }
    
            .chat-list {
                max-height: 400px;
                overflow-y: auto;
                padding: 4px 8px;
            }
    
            .chat-item {
                padding: 10px 12px;
                margin: 2px 0;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                transition: background 0.15s;
            }
    
            .chat-item:hover {
                background: var(--bg-tertiary);
            }
    
            .chat-item.active {
                background: rgba(217, 119, 87, 0.1);
                color: var(--accent-orange);
            }
    
            .chat-item-content {
                flex: 1;
                min-width: 0;
            }
    
            .chat-item-title {
                font-size: 14px;
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
    
            .chat-item-time {
                font-size: 12px;
                color: var(--text-tertiary);
                margin-top: 2px;
            }
    
            .delete-chat-btn {
                background: none;
                border: none;
                color: var(--error-red);
                font-size: 18px;
                cursor: pointer;
                padding: 4px 8px;
                opacity: 0;
                transition: opacity 0.2s;
            }
    
            .chat-item:hover .delete-chat-btn {
                opacity: 1;
            }
    
            .sidebar-footer {
                padding: 12px 16px;
                border-top: 1px solid var(--border-subtle);
            }
    
            .logout-btn {
                width: 100%;
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-subtle);
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            }
    
            .logout-btn:hover {
                background: var(--bg-tertiary);
                color: var(--error-red);
                border-color: var(--error-red);
            }
    
            /* Main Chat Area */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: var(--bg-primary);
                overflow: hidden;
            }
    
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px 16px 140px;
                display: flex;
                flex-direction: column;
            }
    
            /* Empty State */
            .empty-state {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 20px;
            }
    
            .empty-state.hidden {
                display: none;
            }
    
            .logo-container {
                width: 80px;
                height: 80px;
                background: var(--bg-secondary);
                border-radius: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 16px var(--shadow-light);
            }
    
            .logo-svg {
                width: 50px;
                height: 50px;
            }
    
            .welcome-text {
                font-size: 24px;
                font-weight: 500;
                color: var(--text-primary);
                text-align: center;
            }
    
            /* Messages */
            .messages-container {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
    
            .message {
                display: flex;
                gap: 12px;
                max-width: 85%;
            }
    
            .message.user {
                align-self: flex-end;
                flex-direction: row-reverse;
            }
    
            .message-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                flex-shrink: 0;
            }
    
            .message.assistant .message-avatar {
                background: var(--accent-orange);
                color: white;
            }
    
            .message.user .message-avatar {
                background: var(--accent-blue);
                color: white;
            }
    
            .message-bubble {
                background: var(--bg-secondary);
                padding: 12px 16px;
                border-radius: 16px;
                font-size: 15px;
                line-height: 1.5;
                box-shadow: 0 1px 3px var(--shadow-light);
            }
    
            .message.user .message-bubble {
                background: var(--accent-blue);
                color: white;
            }
    
            .message.assistant .message-bubble {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
    
            /* Input Area */
            .input-area {
                position: fixed;
                bottom: 0;
                left: var(--sidebar-width);
                right: 0;
                background: var(--bg-primary);
                padding: 16px 24px 24px;
                border-top: 1px solid var(--border-subtle);
            }
    
            .input-container {
                max-width: 800px;
                margin: 0 auto;
                background: var(--bg-input);
                border: 1px solid var(--border-medium);
                border-radius: 24px;
                padding: 8px 8px 8px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 2px 8px var(--shadow-light);
                transition: all 0.2s;
            }
    
            .input-container:focus-within {
                border-color: var(--accent-orange);
                box-shadow: 0 4px 16px var(--shadow-medium);
            }
    
            .voice-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
    
            .voice-btn:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
    
            .input-field {
                flex: 1;
                background: none;
                border: none;
                color: var(--text-primary);
                font-size: 15px;
                outline: none;
                padding: 8px 4px;
                min-width: 0;
            }
    
            .input-field::placeholder {
                color: var(--text-tertiary);
            }
    
            .send-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: var(--accent-orange);
                color: white;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
    
            .send-btn:hover {
                background: #c96646;
                transform: scale(1.05);
            }
    
            .send-btn:disabled {
                background: var(--bg-tertiary);
                color: var(--text-tertiary);
                cursor: not-allowed;
                transform: none;
            }
    
            /* Thinking Indicator */
            .thinking-indicator {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 12px 0;
            }
    
            .thinking-indicator .dot {
                width: 8px;
                height: 8px;
                background-color: var(--accent-orange);
                border-radius: 50%;
                animation: bounce 1.4s infinite ease-in-out both;
            }
    
            .thinking-indicator .dot:nth-child(1) {
                animation-delay: -0.32s;
            }
    
            .thinking-indicator .dot:nth-child(2) {
                animation-delay: -0.16s;
            }
    
            @keyframes bounce {
                0%, 80%, 100% {
                    transform: scale(0);
                    opacity: 0.5;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
    
            /* Mobile Responsiveness */
            @media (max-width: 768px) {
                .sidebar {
                    position: fixed;
                    left: -100%;
                    top: var(--header-height);
                    height: calc(100vh - var(--header-height));
                    box-shadow: 4px 0 24px var(--shadow-heavy);
                }
    
                .sidebar.open {
                    left: 0;
                }
    
                .sidebar-overlay {
                    position: fixed;
                    top: var(--header-height);
                    left: 0;
                    width: 100%;
                    height: calc(100vh - var(--header-height));
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 80;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.3s;
                }
    
                .sidebar-overlay.show {
                    opacity: 1;
                    pointer-events: all;
                }
    
                .input-area {
                    left: 0;
                    padding: 12px 16px 20px;
                }
    
                .chat-messages {
                    padding: 16px 12px 140px;
                }
    
                .message {
                    max-width: 95%;
                }
            }
    
            @media (min-width: 769px) {
                .sidebar-overlay {
                    display: none;
                }
            }
    
            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
    
            ::-webkit-scrollbar-track {
                background: transparent;
            }
    
            ::-webkit-scrollbar-thumb {
                background: var(--border-medium);
                border-radius: 4px;
            }
    
            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-tertiary);
            }
    
            /* Code blocks */
            pre {
                background: var(--bg-tertiary);
                padding: 16px;
                border-radius: 8px;
                overflow-x: auto;
                margin: 12px 0;
            }
    
            code {
                font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                font-size: 14px;
                color: var(--text-primary);
            }
    
            /* Badge */
            .badge {
                background: rgba(217, 119, 87, 0.15);
                color: var(--accent-orange);
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 600;
            }
    
            /* Collapsible sections */
            .section-header {
                cursor: pointer;
                user-select: none;
            }
    
            .conversation-list {
                transition: all 0.2s ease;
                overflow: hidden;
            }
    
            .conversation-list.collapsed {
                display: none;
            }

            /* Status Indicators */
            .status-section {
                padding: 12px 16px;
            }

            .status-category {
                margin-bottom: 16px;
            }

            .status-category-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 8px;
                cursor: pointer;
            }

            .status-category-title {
                font-size: 11px;
                font-weight: 600;
                letter-spacing: 0.5px;
                color: var(--text-tertiary);
                text-transform: uppercase;
            }

            .status-overall {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .status-overall.healthy {
                background: #4CAF50;
                box-shadow: 0 0 6px rgba(76, 175, 80, 0.5);
            }

            .status-overall.degraded {
                background: #FF9800;
                box-shadow: 0 0 6px rgba(255, 152, 0, 0.5);
            }

            .status-overall.offline {
                background: #f44336;
                box-shadow: 0 0 6px rgba(244, 67, 54, 0.5);
            }

            .status-overall.unknown {
                background: #9E9E9E;
            }

            .status-items {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .status-items.collapsed {
                display: none;
            }

            .status-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 6px 8px;
                background: var(--bg-tertiary);
                border-radius: 6px;
                font-size: 12px;
            }

            .status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .status-dot.connected {
                background: #4CAF50;
            }

            .status-dot.disconnected,
            .status-dot.timeout,
            .status-dot.error {
                background: #f44336;
            }

            .status-dot.unknown {
                background: #9E9E9E;
            }

            .status-name {
                flex: 1;
                color: var(--text-secondary);
            }

            .status-latency {
                font-size: 10px;
                color: var(--text-tertiary);
            }

            .status-refresh {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                padding: 8px;
                margin-top: 8px;
                background: transparent;
                border: 1px solid var(--border-subtle);
                border-radius: 6px;
                color: var(--text-tertiary);
                font-size: 11px;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
            }

            .status-refresh:hover {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
            }

            .status-refresh.loading {
                opacity: 0.6;
                cursor: wait;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            .status-refresh.loading .refresh-icon {
                animation: spin 1s linear infinite;
            }
        </style>
    </head>
    <body>
        <!-- Login Screen -->
        <div id="login-screen" class="active">
            <div class="login-container">
                <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="loginGrad">
                            <stop offset="0%" style="stop-color:#d97757" />
                            <stop offset="100%" style="stop-color:#c96646" />
                        </radialGradient>
                    </defs>
                    <circle cx="50" cy="50" r="8" fill="url(#loginGrad)"/>
                    <g transform="translate(50,50)">
                        <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(0)"/>
                        <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(45)"/>
                        <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(90)"/>
                        <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(135)"/>
                    </g>
                </svg>
                <div>
                    <h1 class="login-title">Cortex Chat</h1>
                    <p class="login-subtitle">Sign in to continue</p>
                </div>
                <form class="login-form" id="loginForm">
                    <div class="login-error" id="loginError">Invalid credentials</div>
                    <div class="login-input-group">
                        <label class="login-label">Username</label>
                        <input type="text" id="username" class="login-input" placeholder="Enter username" autocomplete="username" required>
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Password</label>
                        <input type="password" id="password" class="login-input" placeholder="Enter password" autocomplete="current-password" required>
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
                </form>
            </div>
        </div>
    
        <!-- Main App -->
        <div class="app-container" id="app-container">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle sidebar">‚ò∞</button>
                    <div class="header-logo">
                        <svg width="24" height="24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="8" fill="currentColor"/>
                            <g transform="translate(50,50)">
                                <ellipse rx="3" ry="18" fill="currentColor" transform="rotate(0)"/>
                                <ellipse rx="3" ry="18" fill="currentColor" transform="rotate(45)"/>
                                <ellipse rx="3" ry="18" fill="currentColor" transform="rotate(90)"/>
                                <ellipse rx="3" ry="18" fill="currentColor" transform="rotate(135)"/>
                            </g>
                        </svg>
                        <span>Cortex</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle theme">
                        <span id="themeIcon">‚òÄÔ∏è</span>
                    </button>
                    <button class="profile-btn" id="profileBtn" aria-label="Profile">C</button>
                </div>
            </header>
    
            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Sidebar Overlay for Mobile -->
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
                <!-- Sidebar -->
                <aside class="sidebar" id="sidebar">
                    <button class="new-chat-btn" id="newChatBtn">
                        <span>+</span>
                        <span>New Chat</span>
                    </button>
    
                    <nav class="sidebar-nav">
                        <!-- Chats Section with Multiple Categories -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <span>CHATS</span>
                            </div>
                            
                            <!-- Active Conversations -->
                            <div class="conversations-section">
                                <div class="section-header" onclick="toggleConversationSection('active')" style="padding: 8px 20px; display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 11px; font-weight: 600; letter-spacing: 0.5px; color: var(--text-tertiary);">ACTIVE</span>
                                </div>
                                <div id="active-conversations" class="conversation-list" style="padding: 4px 8px;">
                                    <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No active chats</div>
                                </div>
                            </div>
    
                            <!-- In Progress Conversations -->
                            <div class="conversations-section">
                                <div class="section-header" onclick="toggleConversationSection('in-progress')" style="padding: 8px 20px; display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 11px; font-weight: 600; letter-spacing: 0.5px; color: var(--text-tertiary);">IN PROGRESS</span>
                                    <span class="badge" id="in-progress-count" style="display: none;">0</span>
                                </div>
                                <div id="in-progress-conversations" class="conversation-list collapsed" style="padding: 4px 8px;">
                                    <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No chats in progress</div>
                                </div>
                            </div>
    
                            <!-- Completed Conversations -->
                            <div class="conversations-section">
                                <div class="section-header" onclick="toggleConversationSection('completed')" style="padding: 8px 20px; display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 11px; font-weight: 600; letter-spacing: 0.5px; color: var(--text-tertiary);">COMPLETED</span>
                                    <span class="badge" id="completed-count" style="display: none;">0</span>
                                </div>
                                <div id="completed-conversations" class="conversation-list collapsed" style="padding: 4px 8px;">
                                    <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No completed chats</div>
                                </div>
                            </div>
                        </div>
    
                        <!-- System Status Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <span>SYSTEM STATUS</span>
                            </div>
                            <div class="status-section" id="status-section">
                                <!-- MCP Servers -->
                                <div class="status-category">
                                    <div class="status-category-header" onclick="toggleStatusCategory('mcp')">
                                        <span class="status-category-title">MCP Servers</span>
                                        <div class="status-overall unknown" id="mcp-overall"></div>
                                    </div>
                                    <div class="status-items" id="mcp-items">
                                        <div class="status-item">
                                            <div class="status-dot unknown"></div>
                                            <span class="status-name">Loading...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cortex Fabric -->
                                <div class="status-category">
                                    <div class="status-category-header" onclick="toggleStatusCategory('fabric')">
                                        <span class="status-category-title">Cortex Fabric</span>
                                        <div class="status-overall unknown" id="fabric-overall"></div>
                                    </div>
                                    <div class="status-items" id="fabric-items">
                                        <div class="status-item">
                                            <div class="status-dot unknown"></div>
                                            <span class="status-name">Loading...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Infrastructure -->
                                <div class="status-category">
                                    <div class="status-category-header" onclick="toggleStatusCategory('infra')">
                                        <span class="status-category-title">Infrastructure</span>
                                        <div class="status-overall unknown" id="infra-overall"></div>
                                    </div>
                                    <div class="status-items" id="infra-items">
                                        <div class="status-item">
                                            <div class="status-dot unknown"></div>
                                            <span class="status-name">Loading...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- MCP Call Status -->
                                <div class="status-category">
                                    <div class="status-category-header">
                                        <span class="status-category-title">MCP Call</span>
                                        <div class="status-overall unknown" id="mcp-call-overall"></div>
                                    </div>
                                    <div class="status-items" id="mcp-call-items">
                                        <div class="status-item">
                                            <div class="status-dot unknown" id="mcp-call-dot"></div>
                                            <span class="status-name" id="mcp-call-status">No recent calls</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="status-refresh" id="status-refresh-btn" onclick="refreshStatus()" style="flex: 1;">
                                        <span class="refresh-icon">&#x21bb;</span>
                                        <span>Refresh</span>
                                    </button>
                                    <button class="status-refresh" id="restart-unhealthy-btn" onclick="restartUnhealthyServices()" style="flex: 1; border-color: var(--error-red); color: var(--error-red);">
                                        <span>&#x26A0;</span>
                                        <span>Restart</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>
    
                    <div class="sidebar-footer">
                        <button class="logout-btn" id="logoutBtn">Logout</button>
                    </div>
                </aside>
    
                <!-- Main Content -->
                <main class="main-content">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Empty State -->
                        <div class="empty-state" id="emptyState">
                            <div class="logo-container">
                                <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="8" fill="#d97757"/>
                                    <g transform="translate(50,50)">
                                        <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(0)"/>
                                        <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(45)"/>
                                        <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(90)"/>
                                        <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(135)"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="welcome-text" id="welcomeText">How can I help you today?</div>
                        </div>
    
                        <!-- Messages Container -->
                        <div class="messages-container" id="messagesContainer" style="display: none;">
                            <!-- Messages will be appended here -->
                        </div>
    
                        <!-- Thinking Indicator -->
                        <div id="thinking-indicator" class="thinking-indicator" style="display: none;">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
    
                    <!-- Input Area -->
                    <div class="input-area">
                        <div class="input-container">
                            <button class="voice-btn" id="voiceBtn" aria-label="Voice input">üé§</button>
                            <input type="text" class="input-field" id="messageInput" placeholder="Message Cortex..." autocomplete="off">
                            <button class="send-btn" id="sendBtn" disabled aria-label="Send message">‚Üë</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    
        <script>
            // Configuration
            const API_BASE = window.location.origin;
            const STORAGE_KEYS = {
                AUTH_TOKEN: 'cortex_auth_token',
                USERNAME: 'cortex_username',
                CURRENT_CONV: 'cortex_current_conversation',
                THEME: 'cortex_theme'
            };
    
            const WELCOME_MESSAGES = [
                "How can I help you today?",
                "What would you like to know?",
                "Ready to help with your infrastructure",
                "Ask me about your systems"
            ];
    
            // State
            let currentConversationId = null;
            let isStreaming = false;
            let isAuthenticated = false;
    
            // DOM Elements
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const emptyState = document.getElementById('emptyState');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const logoutBtn = document.getElementById('logoutBtn');
            const profileBtn = document.getElementById('profileBtn');
    
            // Initialize
            function init() {
                loadTheme();
                checkAuthStatus();

                const welcomeText = document.getElementById('welcomeText');
                welcomeText.textContent = WELCOME_MESSAGES[Math.floor(Math.random() * WELCOME_MESSAGES.length)];

                setupEventListeners();

                // Start status polling
                refreshStatus();
                setInterval(refreshStatus, 30000); // Refresh every 30 seconds
            }

            // Status Functions
            let statusRefreshing = false;

            async function refreshStatus() {
                if (statusRefreshing) return;

                const refreshBtn = document.getElementById('status-refresh-btn');
                if (refreshBtn) {
                    refreshBtn.classList.add('loading');
                    statusRefreshing = true;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/status`);
                    if (!response.ok) throw new Error('Failed to fetch status');

                    const data = await response.json();
                    updateStatusUI(data);
                } catch (error) {
                    console.error('Status fetch error:', error);
                    // Show error state
                    setStatusError();
                } finally {
                    if (refreshBtn) {
                        refreshBtn.classList.remove('loading');
                        statusRefreshing = false;
                    }
                }
            }

            function updateStatusUI(data) {
                // Update MCP Servers
                updateStatusCategory('mcp', data.mcp_servers, data.overall?.mcp_servers);

                // Update Cortex Fabric
                updateStatusCategory('fabric', data.cortex_fabric, data.overall?.cortex_fabric);

                // Update Infrastructure
                updateStatusCategory('infra', data.infrastructure, data.overall?.infrastructure);

                // Update MCP Call status
                const mcpCallOverall = document.getElementById('mcp-call-overall');
                const mcpCallDot = document.getElementById('mcp-call-dot');
                const mcpCallStatus = document.getElementById('mcp-call-status');

                if (data.mcp_call) {
                    const status = data.mcp_call.status || 'unknown';
                    if (mcpCallOverall) {
                        mcpCallOverall.className = 'status-overall ' + (status === 'connected' ? 'healthy' : status);
                    }
                    if (mcpCallDot) {
                        mcpCallDot.className = 'status-dot ' + status;
                    }
                    if (mcpCallStatus) {
                        mcpCallStatus.textContent = data.mcp_call.last_call || 'No recent calls';
                    }
                }
            }

            function updateStatusCategory(categoryId, items, overallStatus) {
                const overallEl = document.getElementById(`${categoryId}-overall`);
                const itemsEl = document.getElementById(`${categoryId}-items`);

                if (overallEl) {
                    overallEl.className = 'status-overall ' + (overallStatus || 'unknown');
                }

                if (itemsEl && items && items.length > 0) {
                    itemsEl.innerHTML = items.map(item => `
                        <div class="status-item">
                            <div class="status-dot ${item.status}"></div>
                            <span class="status-name">${item.name}</span>
                            ${item.latency_ms ? `<span class="status-latency">${item.latency_ms}ms</span>` : ''}
                        </div>
                    `).join('');
                } else if (itemsEl) {
                    itemsEl.innerHTML = `
                        <div class="status-item">
                            <div class="status-dot unknown"></div>
                            <span class="status-name">No services found</span>
                        </div>
                    `;
                }
            }

            function setStatusError() {
                ['mcp', 'fabric', 'infra'].forEach(cat => {
                    const overallEl = document.getElementById(`${cat}-overall`);
                    const itemsEl = document.getElementById(`${cat}-items`);

                    if (overallEl) overallEl.className = 'status-overall offline';
                    if (itemsEl) {
                        itemsEl.innerHTML = `
                            <div class="status-item">
                                <div class="status-dot error"></div>
                                <span class="status-name">Connection error</span>
                            </div>
                        `;
                    }
                });
            }

            function toggleStatusCategory(categoryId) {
                const itemsEl = document.getElementById(`${categoryId}-items`);
                if (itemsEl) {
                    itemsEl.classList.toggle('collapsed');
                }
            }

            async function restartUnhealthyServices() {
                const restartBtn = document.getElementById('restart-unhealthy-btn');
                if (restartBtn.classList.contains('loading')) return;

                if (!confirm('Restart all unhealthy services? This may cause brief service interruptions.')) {
                    return;
                }

                restartBtn.classList.add('loading');
                restartBtn.innerHTML = '<span class="refresh-icon">&#x21bb;</span><span>Restarting...</span>';

                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/restart`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ restart_all_unhealthy: true })
                    });

                    const data = await response.json();

                    if (data.restarted && data.restarted.length > 0) {
                        const names = data.restarted.map(s => s.name).join(', ');
                        alert(`Restarted: ${names}\n\nServices will be back online shortly.`);
                    } else if (data.message) {
                        alert(data.message);
                    } else if (data.failed && data.failed.length > 0) {
                        const errors = data.failed.map(s => `${s.name}: ${s.error}`).join('\n');
                        alert(`Some services failed to restart:\n${errors}`);
                    }

                    // Refresh status after a delay
                    setTimeout(refreshStatus, 5000);

                } catch (error) {
                    console.error('Restart error:', error);
                    alert('Failed to restart services: ' + error.message);
                } finally {
                    restartBtn.classList.remove('loading');
                    restartBtn.innerHTML = '<span>&#x26A0;</span><span>Restart</span>';
                }
            }

            async function restartService(serviceName) {
                if (!confirm(`Restart ${serviceName}?`)) return;

                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/restart/${serviceName}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    const data = await response.json();
                    if (data.restarted && data.restarted.length > 0) {
                        alert(`${serviceName} is restarting...`);
                        setTimeout(refreshStatus, 5000);
                    } else {
                        alert(`Failed to restart ${serviceName}`);
                    }
                } catch (error) {
                    alert('Restart failed: ' + error.message);
                }
            }

            // Theme Management
            function loadTheme() {
                const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME) || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            }
    
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem(STORAGE_KEYS.THEME, newTheme);
                updateThemeIcon(newTheme);
            }
    
            function updateThemeIcon(theme) {
                themeIcon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            }
    
            // Auth Functions
            function checkAuthStatus() {
                const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const username = localStorage.getItem(STORAGE_KEYS.USERNAME);

                if (token && username) {
                    showChatInterface();
                    if (username && username.length > 0) {
                        profileBtn.textContent = username.charAt(0).toUpperCase();
                    }
                } else {
                    showLoginScreen();
                }
            }
    
            function showLoginScreen(message = null) {
                isAuthenticated = false;
                loginScreen.classList.add('active');
                appContainer.classList.remove('authenticated');
    
                if (message) {
                    loginError.textContent = message;
                    loginError.classList.add('show');
                }
            }
    
            function showChatInterface() {
                isAuthenticated = true;
                loginScreen.classList.remove('active');
                appContainer.classList.add('authenticated');
                loadConversations();
    
                const currentConv = localStorage.getItem(STORAGE_KEYS.CURRENT_CONV);
                if (currentConv) {
                    currentConversationId = currentConv;
                    loadConversation(currentConv);
                }
            }
    
            // Event Listeners
            function setupEventListeners() {
                loginForm.addEventListener('submit', handleLogin);
                hamburgerBtn.addEventListener('click', toggleSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);
                themeToggle.addEventListener('click', toggleTheme);
                logoutBtn.addEventListener('click', logout);
                newChatBtn.addEventListener('click', startNewChat);
    
                // Navigation click handlers removed - About section is now informational only
    
                messageInput.addEventListener('input', () => {
                    sendBtn.disabled = !messageInput.value.trim();
                });
    
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
    
                sendBtn.addEventListener('click', sendMessage);
    
                // Close sidebar on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                        closeSidebar();
                    }
                });
            }
    
            // Sidebar Functions
            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('show');
            }
    
            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('show');
            }
    
            function toggleSection(sectionId) {
                const section = document.getElementById(`${sectionId}-section`);
                if (section) {
                    section.classList.toggle('collapsed');
                }
            }
    
            // Toggle conversation sections (active/in-progress/completed)
            function toggleConversationSection(sectionId) {
                const list = document.getElementById(`${sectionId}-conversations`);
                if (list) {
                    list.classList.toggle('collapsed');
                }
            }
    
            // Login
            async function handleLogin(e) {
                e.preventDefault();
    
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
    
                if (!username || !password) {
                    loginError.textContent = 'Please enter username and password';
                    loginError.classList.add('show');
                    return;
                }
    
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Signing in...';
    
                try {
                    const response = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
    
                    const data = await response.json();
    
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'Login failed');
                    }
    
                    localStorage.setItem(STORAGE_KEYS.AUTH_TOKEN, data.token);
                    localStorage.setItem(STORAGE_KEYS.USERNAME, data.username);

                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    loginError.classList.remove('show');

                    if (data.username && data.username.length > 0) {
                        profileBtn.textContent = data.username.charAt(0).toUpperCase();
                    }
                    showChatInterface();
    
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = error.message || 'Login failed. Please try again.';
                    loginError.classList.add('show');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            }
    
            function logout() {
                localStorage.removeItem(STORAGE_KEYS.AUTH_TOKEN);
                localStorage.removeItem(STORAGE_KEYS.USERNAME);
                currentConversationId = null;
                localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
                closeSidebar();
                showLoginScreen();
            }
    
            function handleAuthError() {
                localStorage.removeItem(STORAGE_KEYS.AUTH_TOKEN);
                localStorage.removeItem(STORAGE_KEYS.USERNAME);
                showLoginScreen('Session expired. Please sign in again.');
            }
    
            // Conversation Functions with Multi-Section Support
            async function loadConversations() {
                const activeList = document.getElementById('active-conversations');
                activeList.innerHTML = '<div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">Loading...</div>';
    
                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/conversations`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
    
                    if (response.status === 401) {
                        handleAuthError();
                        return;
                    }
    
                    if (!response.ok) throw new Error('Failed to load conversations');
    
                    const data = await response.json();
    
                    // Check if backend supports grouped conversations
                    if (data.conversations && data.conversations.active !== undefined) {
                        // Backend provides categorized conversations
                        renderConversationList('active', data.conversations.active || []);
                        renderConversationList('in-progress', data.conversations.in_progress || []);
                        renderConversationList('completed', data.conversations.completed || []);
    
                        // Update badges
                        updateBadge('in-progress-count', (data.conversations.in_progress || []).length);
                        updateBadge('completed-count', (data.conversations.completed || []).length);
                    } else {
                        // Fallback: Backend sends flat list, put all in active
                        const conversations = data.conversations || [];
                        renderConversationList('active', conversations);
                        renderConversationList('in-progress', []);
                        renderConversationList('completed', []);
    
                        updateBadge('in-progress-count', 0);
                        updateBadge('completed-count', 0);
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    activeList.innerHTML = '<div style="padding: 16px; color: var(--error-red); text-align: center; font-size: 12px;">Failed to load</div>';
                }
            }
    
            function renderConversationList(category, conversations) {
                const listElement = document.getElementById(`${category}-conversations`);
                if (!listElement) return;
                
                listElement.innerHTML = '';
    
                if (conversations.length === 0) {
                    const emptyMessages = {
                        'active': 'No active chats',
                        'in-progress': 'No chats in progress',
                        'completed': 'No completed chats'
                    };
                    listElement.innerHTML = `<div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">${emptyMessages[category]}</div>`;
                    return;
                }
    
                conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    if (conv.sessionId === currentConversationId) {
                        item.classList.add('active');
                    }
    
                    const content = document.createElement('div');
                    content.className = 'chat-item-content';
    
                    const title = document.createElement('div');
                    title.className = 'chat-item-title';
                    title.textContent = conv.title || `Chat ${formatTime(conv.createdAt)}`;
    
                    const time = document.createElement('div');
                    time.className = 'chat-item-time';
                    time.textContent = formatTime(conv.updatedAt);
    
                    content.appendChild(title);
                    content.appendChild(time);
    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-chat-btn';
                    deleteBtn.innerHTML = '√ó';
    
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await deleteConversation(conv.sessionId);
                    });
    
                    content.addEventListener('click', async () => {
                        currentConversationId = conv.sessionId;
                        localStorage.setItem(STORAGE_KEYS.CURRENT_CONV, conv.sessionId);
                        await loadConversation(conv.sessionId);
                        closeSidebar();
                        await loadConversations();
                    });
    
                    item.appendChild(content);
                    item.appendChild(deleteBtn);
                    listElement.appendChild(item);
                });
            }
    
            function updateBadge(badgeId, count) {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
    
            async function loadConversation(conversationId, forceReload = false) {
                if (isStreaming && !forceReload) {
                    console.log('[LoadConversation] Skipping reload - streaming in progress');
                    return;
                }
    
                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/conversations/${conversationId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
    
                    if (response.status === 401) {
                        handleAuthError();
                        return;
                    }
    
                    if (!response.ok) throw new Error('Failed to load conversation');
    
                    const data = await response.json();
                    const conv = data.conversation;
    
                    if (!conv) return;
    
                    emptyState.classList.add('hidden');
                    messagesContainer.style.display = 'flex';
                    messagesContainer.innerHTML = '';
    
                    conv.messages.forEach(msg => {
                        appendMessage(msg.role, msg.content, false);
                    });
    
                    scrollToBottom();
                } catch (error) {
                    console.error('Error loading conversation:', error);
                }
            }
    
            async function deleteConversation(conversationId) {
                if (!confirm('Delete this chat?')) return;
    
                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/conversations/${conversationId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
    
                    if (response.status === 401) {
                        handleAuthError();
                        return;
                    }
    
                    if (!response.ok) throw new Error('Failed to delete conversation');
    
                    if (currentConversationId === conversationId) {
                        currentConversationId = null;
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
                        messagesContainer.innerHTML = '';
                        messagesContainer.style.display = 'none';
                        emptyState.classList.remove('hidden');
                    }
    
                    await loadConversations();
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                    alert('Failed to delete conversation');
                }
            }
    
            function startNewChat() {
                currentConversationId = null;
                localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
                messagesContainer.innerHTML = '';
                messagesContainer.style.display = 'none';
                emptyState.classList.remove('hidden');
                closeSidebar();
                loadConversations();
                messageInput.focus();
            }
    
            // Message Functions
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;
    
                if (!isAuthenticated) {
                    showLoginScreen('Please sign in to continue');
                    return;
                }
    
                messageInput.disabled = true;
                sendBtn.disabled = true;
                isStreaming = true;
    
                emptyState.classList.add('hidden');
                messagesContainer.style.display = 'flex';
    
                appendMessage('user', message);
                messageInput.value = '';
    
                document.getElementById('thinking-indicator').style.display = 'flex';
    
                if (!currentConversationId) {
                    currentConversationId = generateId();
                    localStorage.setItem(STORAGE_KEYS.CURRENT_CONV, currentConversationId);
                }
    
                let history = [];
                try {
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const convResponse = await fetch(`${API_BASE}/api/conversations/${currentConversationId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
    
                    if (convResponse.ok) {
                        const convData = await convResponse.json();
                        history = convData.conversation?.messages || [];
                    }
                } catch (e) {
                    // No existing conversation
                }
    
                try {
                    const requestBody = {
                        message: message,
                        sessionId: currentConversationId || `session-${Date.now()}`
                    };
    
                    if (history.length > 0) {
                        requestBody.history = history;
                    }
    
                    const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                    const response = await fetch(`${API_BASE}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(requestBody)
                    });
    
                    if (response.status === 401) {
                        handleAuthError();
                        return;
                    }
    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }
    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    let messageDiv = null;
    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
    
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
    
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6).trim();
    
                                if (dataStr === '[DONE]') continue;
    
                                try {
                                    const data = JSON.parse(dataStr);
    
                                    if (data.type === 'content_block_delta' && data.delta) {
                                        assistantMessage += data.delta;
    
                                        if (!messageDiv) {
                                            messageDiv = appendMessage('assistant', assistantMessage);
                                        } else {
                                            const bubble = messageDiv.querySelector('.message-bubble');
                                            bubble.innerHTML = formatMarkdown(assistantMessage);
                                        }
                                        scrollToBottom();
                                    }
                                    else if (data.type === 'message_stop') {
                                        if (assistantMessage) {
                                            await loadConversations();
                                        }
                                    }
                                    else if (data.type === 'error') {
                                        throw new Error(data.error || 'Unknown error occurred');
                                    }
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Chat error:', error);
    
                    if (error.message.includes('401') || error.message.includes('unauthorized')) {
                        handleAuthError();
                        return;
                    }
    
                    appendMessage('assistant', `Error: ${error.message}`);
                } finally {
                    document.getElementById('thinking-indicator').style.display = 'none';
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    isStreaming = false;
                    messageInput.focus();
    
                    setTimeout(async () => {
                        await loadConversation(currentConversationId, true);
                    }, 500);
                }
            }
    
            function appendMessage(role, content, save = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
    
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = role === 'user' ? 'U' : 'C';
    
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = formatMarkdown(content);
    
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                messagesContainer.appendChild(messageDiv);
    
                scrollToBottom();
                return messageDiv;
            }
    
            // Utility Functions
            function formatMarkdown(text) {
                let formatted = text;
    
                // Code blocks
                formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
                });
    
                // Inline code
                formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
    
                // Bold
                formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
                // Line breaks
                formatted = formatted.replace(/\n/g, '<br>');
    
                return formatted;
            }
    
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
    
            function formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
    
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return `${Math.floor(diff / 86400000)}d ago`;
            }
    
            function generateId() {
                return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }
    
            function scrollToBottom() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
    
            // Initialize app
            init();
        </script>
    </body>
    </html>
