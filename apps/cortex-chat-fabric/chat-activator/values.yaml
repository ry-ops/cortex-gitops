# =============================================================================
# Chat Activator - Master Orchestrator for Cortex Chat
# =============================================================================
# The central hub that:
# - Receives chat requests from frontend
# - Routes to intent classifier
# - Dispatches to appropriate domain fabrics (UniFi, Infrastructure, etc.)
# - Aggregates responses back to users
# - Manages conversation state in Redis
# =============================================================================

global:
  namespace: cortex-chat

# -----------------------------------------------------------------------------
# Deployment
# -----------------------------------------------------------------------------
replicaCount: 1

image:
  repository: python
  tag: "3.11-slim"
  pullPolicy: IfNotPresent

# Minimal resources within LimitRange constraints
# LimitRange: min 50m CPU / 64Mi memory, max ratio 4:1 CPU / 2:1 memory
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "400m"

# Init container resources - must meet minimums (50m CPU, 64Mi memory)
initContainerResources:
  gitSync:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "200m"
  installDeps:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "400m"

# -----------------------------------------------------------------------------
# Service
# -----------------------------------------------------------------------------
service:
  type: ClusterIP
  port: 8080

# -----------------------------------------------------------------------------
# Redis Configuration (Conversation Storage + Fabric Communication)
# -----------------------------------------------------------------------------
redis:
  host: "redis.cortex-chat.svc.cluster.local"
  port: 6379
  secretName: "cortex-chat-secrets"
  passwordKey: "redis-password"
  # Redis Streams for fabric communication
  streams:
    tasks: "cortex.chat.tasks"
    results: "cortex.results"
    consumerGroup: "chat-activator"

# -----------------------------------------------------------------------------
# Anthropic API
# -----------------------------------------------------------------------------
anthropic:
  secretName: "cortex-chat-secrets"
  apiKeyKey: "anthropic-api-key"
  model: "claude-sonnet-4-20250514"
  maxTokens: 4096

# -----------------------------------------------------------------------------
# Domain Fabrics (for routing)
# -----------------------------------------------------------------------------
fabrics:
  unifi:
    stream: "cortex.network.tasks"
    capabilities:
      - network
      - wifi
      - unifi
      - clients
      - devices
  proxmox:
    stream: "cortex.proxmox.tasks"
    capabilities:
      - proxmox
      - vm
      - virtual_machine
      - lxc
      - pve
      - storage
  kubernetes:
    stream: "cortex.kubernetes.tasks"
    capabilities:
      - kubernetes
      - k8s
      - pod
      - pods
      - deployment
      - service
      - ingress
      - namespace
  github:
    stream: "cortex.github.tasks"
    capabilities:
      - github
      - repository
      - issues
      - pull_requests
      - commits
      - branches
      - workflows
  cloudflare:
    stream: "cortex.cloudflare.tasks"
    capabilities:
      - cloudflare
      - dns
      - tunnel
      - waf
      - firewall
      - zones
  sandfly:
    stream: "cortex.sandfly.tasks"
    capabilities:
      - sandfly
      - threat
      - alerts
      - host_security
      - compliance
      - scan
  cortex:
    stream: "cortex.cortex.tasks"
    capabilities:
      - cortex
      - agent
      - fabric
      - status
      - help
      - system

# -----------------------------------------------------------------------------
# MCP Server Integration (Direct fallback)
# -----------------------------------------------------------------------------
mcpServers:
  - name: cortex-mcp
    url: "http://cortex-mcp-server.cortex-system.svc.cluster.local:3000"
  - name: proxmox-mcp
    url: "http://proxmox-mcp-server.cortex-system.svc.cluster.local:3000"
  - name: unifi-mcp
    url: "http://unifi-mcp-server.cortex-system.svc.cluster.local:3000"
  - name: sandfly-mcp
    url: "http://sandfly-mcp-server.cortex-system.svc.cluster.local:3000"
  - name: kubernetes-mcp
    url: "http://kubernetes-mcp-server.cortex-system.svc.cluster.local:3001"
  - name: github-mcp
    url: "http://github-mcp-server.cortex-system.svc.cluster.local:3002"
  - name: cloudflare-mcp
    url: "http://cloudflare-mcp-server.cortex-system.svc.cluster.local:3000"

# -----------------------------------------------------------------------------
# Metrics
# -----------------------------------------------------------------------------
metrics:
  enabled: true
  port: 9090

# -----------------------------------------------------------------------------
# Ingress (disabled by default - parallel deploy with moe-router)
# -----------------------------------------------------------------------------
ingress:
  enabled: false
  host: "chat-fabric.ry-ops.dev"
  tlsSecret: "chat-fabric-tls"

# -----------------------------------------------------------------------------
# KEDA Scaling (optional - keep at 1 for now)
# -----------------------------------------------------------------------------
keda:
  enabled: false
  minReplicaCount: 1
  maxReplicaCount: 3
