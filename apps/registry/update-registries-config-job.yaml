apiVersion: v1
kind: ConfigMap
metadata:
  name: registries-config
  namespace: registry
data:
  registries.yaml: |
    mirrors:
      docker.io:
        endpoint:
          - "http://localhost:30500"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: node-config-updater
  namespace: registry
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: update-registries-config
  namespace: registry
  annotations:
    description: "Updates /etc/rancher/k3s/registries.yaml on all nodes to use NodePort"
spec:
  selector:
    matchLabels:
      app: update-registries-config
  template:
    metadata:
      labels:
        app: update-registries-config
    spec:
      serviceAccountName: node-config-updater
      hostPID: true
      tolerations:
      - operator: Exists
      containers:
      - name: updater
        image: busybox:latest
        securityContext:
          privileged: true
        command:
        - /bin/sh
        - -c
        - |
          echo "Updating /etc/rancher/k3s/registries.yaml on $(hostname)..."

          # Copy the new config to the host
          cp /config/registries.yaml /host/etc/rancher/k3s/registries.yaml

          echo "Updated registries.yaml:"
          cat /host/etc/rancher/k3s/registries.yaml

          echo ""
          echo "NOTE: k3s needs to be restarted for changes to take effect."
          echo "Run on each node: sudo systemctl restart k3s (or k3s-agent)"
          echo ""
          echo "Sleeping to keep pod running for logs inspection..."
          sleep infinity
        volumeMounts:
        - name: host-etc
          mountPath: /host/etc/rancher/k3s
        - name: config
          mountPath: /config
      volumes:
      - name: host-etc
        hostPath:
          path: /etc/rancher/k3s
          type: DirectoryOrCreate
      - name: config
        configMap:
          name: registries-config
