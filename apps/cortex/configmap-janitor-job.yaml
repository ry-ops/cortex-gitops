apiVersion: batch/v1
kind: Job
metadata:
  name: configmap-janitor
  namespace: cortex
  labels:
    app: configmap-janitor
    component: cleanup
    priority: high
spec:
  ttlSecondsAfterFinished: 86400  # Keep for 24 hours
  backoffLimit: 1
  template:
    metadata:
      labels:
        app: configmap-janitor
        component: cleanup
    spec:
      restartPolicy: OnFailure
      serviceAccountName: configmap-janitor-sa
      containers:
      - name: janitor
        image: rancher/kubectl:v1.28.3
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=== ConfigMap Janitor - Cortex Namespace Cleanup ==="
          echo "Date: $(date)"
          echo ""

          # Step 1: Increase ResourceQuota temporarily
          echo "Step 1: Temporarily increasing ConfigMap quota (30 â†’ 50)"
          kubectl patch resourcequota cortex-quota -n cortex --type=merge -p '{"spec":{"hard":{"configmaps":"50"}}}'
          echo "âœ… Quota increased to 50"
          echo ""

          # Step 2: Analyze current ConfigMaps
          echo "Step 2: Analyzing ConfigMaps..."
          TOTAL=$(kubectl get configmaps -n cortex --no-headers | wc -l)
          echo "Total ConfigMaps: $TOTAL"
          echo ""

          # Step 3: Identify ConfigMaps in use by running pods
          echo "Step 3: Identifying ConfigMaps mounted by running pods..."
          PROTECTED_CONFIGMAPS=$(kubectl get pods -n cortex -o json | jq -r '.items[] | select(.status.phase == "Running") | .spec.volumes[]? | select(.configMap != null) | .configMap.name' | sort -u)
          echo "Protected ConfigMaps (in use by running pods):"
          echo "$PROTECTED_CONFIGMAPS"
          echo ""

          # Step 4: Identify build artifacts and old snapshots
          echo "Step 4: Identifying cleanup candidates..."

          # Patterns for build artifacts
          BUILD_PATTERNS=(
            "-dockerfile$"
            "-build$"
            "-build-"
            "-code$"
            "-source$"
            "-js$"
            "-package-json$"
            "-patch"
            "-fixed$"
            "-updated$"
            "-context"
            "-inline$"
            "-final$"
          )

          # Get all ConfigMaps older than 48 hours
          CANDIDATES=$(kubectl get configmaps -n cortex --sort-by=.metadata.creationTimestamp -o json | \
            jq -r --argjson now "$(date +%s)" \
            '.items[] |
            select((.metadata.creationTimestamp | fromdateiso8601) < ($now - 172800)) |
            select(.metadata.name != "kube-root-ca.crt") |
            .metadata.name')

          echo "ConfigMaps older than 48 hours (excluding kube-root-ca.crt):"
          echo "$CANDIDATES"
          echo ""

          # Step 5: Build deletion list (old + matches patterns + not protected)
          TO_DELETE=""
          for cm in $CANDIDATES; do
            # Check if protected
            if echo "$PROTECTED_CONFIGMAPS" | grep -q "^${cm}$"; then
              echo "âš ï¸  SKIP: $cm (in use by running pod)"
              continue
            fi

            # Check if matches build pattern
            MATCHES_PATTERN=false
            for pattern in "${BUILD_PATTERNS[@]}"; do
              if echo "$cm" | grep -qE "$pattern"; then
                MATCHES_PATTERN=true
                break
              fi
            done

            if [ "$MATCHES_PATTERN" = true ]; then
              TO_DELETE="$TO_DELETE $cm"
              echo "ðŸ—‘ï¸  DELETE: $cm (matches build artifact pattern)"
            else
              echo "âš ï¸  SKIP: $cm (old but doesn't match cleanup patterns)"
            fi
          done

          echo ""
          echo "Step 6: Executing cleanup..."

          DELETED_COUNT=0
          for cm in $TO_DELETE; do
            echo "Deleting: $cm"
            kubectl delete configmap "$cm" -n cortex
            DELETED_COUNT=$((DELETED_COUNT + 1))
          done

          echo ""
          echo "âœ… Deleted $DELETED_COUNT ConfigMaps"

          # Step 7: Verify new count
          NEW_TOTAL=$(kubectl get configmaps -n cortex --no-headers | wc -l)
          echo "ConfigMaps remaining: $NEW_TOTAL"

          # Step 8: Restore quota if we're under 30
          if [ "$NEW_TOTAL" -le 25 ]; then
            echo ""
            echo "Step 7: Restoring ConfigMap quota (50 â†’ 30)"
            kubectl patch resourcequota cortex-quota -n cortex --type=merge -p '{"spec":{"hard":{"configmaps":"30"}}}'
            echo "âœ… Quota restored to 30"
          else
            echo ""
            echo "âš ï¸  Still using $NEW_TOTAL ConfigMaps - keeping quota at 50 for now"
            echo "   Manual intervention needed to get under 30"
          fi

          echo ""
          echo "=== CLEANUP COMPLETE ==="
          echo "Before: $TOTAL ConfigMaps"
          echo "After: $NEW_TOTAL ConfigMaps"
          echo "Deleted: $DELETED_COUNT ConfigMaps"
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
