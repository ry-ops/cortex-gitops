apiVersion: v1
kind: ConfigMap
metadata:
  name: unifi-mcp-fixed-code
  namespace: cortex-system
  labels:
    app: unifi-mcp-server
data:
  main.py: |
    # main.py
    # UniFi MCP Server â€” UI.com Cloud API ONLY
    # Uses https://api.ui.com/v1/ with X-API-KEY header
    # NO legacy API, NO local controller access

    from typing import Any, Dict, List, Optional
    from datetime import datetime
    import os
    import json
    import requests
    from mcp.server.fastmcp import FastMCP

    # ========= Configuration =========
    # UI.com Cloud API - THE ONLY API WE USE
    UNIFI_API_BASE = os.getenv("UNIFI_API_BASE", "https://api.ui.com")
    UNIFI_API_KEY = os.getenv("UNIFI_API_KEY", "")
    UNIFI_API_VERSION = os.getenv("UNIFI_API_VERSION", "v1")

    # Build base URL
    API_BASE = f"{UNIFI_API_BASE.rstrip('/')}/{UNIFI_API_VERSION}"

    REQUEST_TIMEOUT_S = int(os.getenv("UNIFI_TIMEOUT_S", "30"))

    mcp = FastMCP("unifi")

    # ========= API Helper Functions =========
    def _headers() -> Dict[str, str]:
        """Get headers for UI.com Cloud API requests"""
        return {
            "X-API-KEY": UNIFI_API_KEY,
            "Accept": "application/json",
            "Content-Type": "application/json"
        }

    def _get(endpoint: str, params: Optional[Dict] = None) -> Dict[str, Any]:
        """Make GET request to UI.com Cloud API"""
        url = f"{API_BASE}/{endpoint.lstrip('/')}"
        r = requests.get(url, headers=_headers(), params=params, timeout=REQUEST_TIMEOUT_S)
        r.raise_for_status()
        return r.json()

    def _post(endpoint: str, body: Optional[Dict] = None) -> Dict[str, Any]:
        """Make POST request to UI.com Cloud API"""
        url = f"{API_BASE}/{endpoint.lstrip('/')}"
        r = requests.post(url, headers=_headers(), json=body, timeout=REQUEST_TIMEOUT_S)
        r.raise_for_status()
        return r.json()

    def _put(endpoint: str, body: Optional[Dict] = None) -> Dict[str, Any]:
        """Make PUT request to UI.com Cloud API"""
        url = f"{API_BASE}/{endpoint.lstrip('/')}"
        r = requests.put(url, headers=_headers(), json=body, timeout=REQUEST_TIMEOUT_S)
        r.raise_for_status()
        return r.json()

    def _delete(endpoint: str) -> Dict[str, Any]:
        """Make DELETE request to UI.com Cloud API"""
        url = f"{API_BASE}/{endpoint.lstrip('/')}"
        r = requests.delete(url, headers=_headers(), timeout=REQUEST_TIMEOUT_S)
        r.raise_for_status()
        return r.json()

    # ========= Health Check =========
    def _health_check() -> Dict[str, Any]:
        """Check API health by fetching hosts"""
        try:
            result = _get("/hosts")
            hosts = result.get("data", [])
            return {
                "ok": True,
                "hosts_count": len(hosts),
                "api_base": API_BASE,
                "api_mode": "cloud"
            }
        except Exception as e:
            return {
                "ok": False,
                "error": str(e),
                "api_base": API_BASE,
                "api_mode": "cloud"
            }

    # ========= MCP Resources =========
    @mcp.resource("health://unifi")
    async def health_resource() -> str:
        """UniFi Cloud API health status"""
        result = _health_check()
        return json.dumps(result, indent=2)

    @mcp.resource("hosts://unifi")
    async def hosts_resource() -> str:
        """List all UniFi hosts (consoles)"""
        try:
            result = _get("/hosts")
            return json.dumps(result.get("data", []), indent=2)
        except Exception as e:
            return json.dumps({"error": str(e)})

    @mcp.resource("sites://unifi")
    async def sites_resource() -> str:
        """List all UniFi sites"""
        try:
            result = _get("/sites")
            return json.dumps(result.get("data", []), indent=2)
        except Exception as e:
            return json.dumps({"error": str(e)})

    @mcp.resource("devices://unifi")
    async def devices_resource() -> str:
        """List all UniFi devices"""
        try:
            result = _get("/devices")
            return json.dumps(result.get("data", []), indent=2)
        except Exception as e:
            return json.dumps({"error": str(e)})

    # ========= MCP Tools =========
    @mcp.tool()
    def get_system_health() -> Dict[str, Any]:
        """Get UniFi Cloud API health status"""
        return _health_check()

    @mcp.tool()
    def list_hosts() -> Dict[str, Any]:
        """
        List all UniFi hosts (consoles) registered with UI.com

        Returns list of hosts with their status, type, and details
        """
        try:
            result = _get("/hosts")
            hosts = result.get("data", [])
            return {
                "ok": True,
                "count": len(hosts),
                "hosts": hosts
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def list_sites() -> Dict[str, Any]:
        """
        List all UniFi sites

        Returns list of sites with their configuration
        """
        try:
            result = _get("/sites")
            sites = result.get("data", [])
            return {
                "ok": True,
                "count": len(sites),
                "sites": sites
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def list_devices(host_id: Optional[str] = None) -> Dict[str, Any]:
        """
        List all UniFi devices

        Args:
            host_id: Optional host ID to filter devices by

        Returns list of devices with their status and details
        """
        try:
            params = {}
            if host_id:
                params["hostId"] = host_id
            result = _get("/devices", params=params)
            devices = result.get("data", [])
            return {
                "ok": True,
                "count": len(devices),
                "devices": devices
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def get_device(device_id: str) -> Dict[str, Any]:
        """
        Get details for a specific device

        Args:
            device_id: The device ID to look up
        """
        try:
            result = _get(f"/devices/{device_id}")
            return {
                "ok": True,
                "device": result.get("data", result)
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def get_host(host_id: str) -> Dict[str, Any]:
        """
        Get details for a specific host (console)

        Args:
            host_id: The host ID to look up
        """
        try:
            result = _get(f"/hosts/{host_id}")
            return {
                "ok": True,
                "host": result.get("data", result)
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def get_site(site_id: str) -> Dict[str, Any]:
        """
        Get details for a specific site

        Args:
            site_id: The site ID to look up
        """
        try:
            result = _get(f"/sites/{site_id}")
            return {
                "ok": True,
                "site": result.get("data", result)
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def get_network_status() -> Dict[str, Any]:
        """
        Get comprehensive network status report

        Returns summary of all hosts, sites, and devices
        """
        try:
            # Get hosts
            hosts_result = _get("/hosts")
            hosts = hosts_result.get("data", [])

            # Get sites
            sites_result = _get("/sites")
            sites = sites_result.get("data", [])

            # Get devices
            devices_result = _get("/devices")
            devices = devices_result.get("data", [])

            # Summarize devices by type and status
            device_summary = {}
            online_count = 0
            offline_count = 0

            for d in devices:
                dtype = d.get("productLine", d.get("type", "unknown"))
                device_summary[dtype] = device_summary.get(dtype, 0) + 1

                state = d.get("reportedState", {})
                if state.get("state") == "connected":
                    online_count += 1
                else:
                    offline_count += 1

            return {
                "ok": True,
                "summary": {
                    "hosts": len(hosts),
                    "sites": len(sites),
                    "devices": {
                        "total": len(devices),
                        "online": online_count,
                        "offline": offline_count,
                        "by_type": device_summary
                    }
                },
                "hosts": [
                    {
                        "id": h.get("id"),
                        "name": h.get("reportedState", {}).get("hostname", h.get("hardwareId")),
                        "type": h.get("type")
                    }
                    for h in hosts
                ],
                "devices": [
                    {
                        "id": d.get("id"),
                        "name": d.get("reportedState", {}).get("name", d.get("hardwareId")),
                        "type": d.get("productLine", d.get("type")),
                        "ip": d.get("reportedState", {}).get("ip"),
                        "status": "online" if d.get("reportedState", {}).get("state") == "connected" else "offline"
                    }
                    for d in devices
                ]
            }
        except Exception as e:
            return {"ok": False, "error": str(e)}

    @mcp.tool()
    def debug_api() -> Dict[str, Any]:
        """
        Debug API configuration and connectivity

        Returns configuration and test results
        """
        result = {
            "config": {
                "api_base": API_BASE,
                "api_key_configured": bool(UNIFI_API_KEY),
                "api_key_prefix": UNIFI_API_KEY[:8] + "..." if UNIFI_API_KEY else None,
                "timeout": REQUEST_TIMEOUT_S
            },
            "tests": {}
        }

        # Test hosts endpoint
        try:
            hosts = _get("/hosts")
            result["tests"]["hosts"] = {
                "status": "ok",
                "count": len(hosts.get("data", []))
            }
        except Exception as e:
            result["tests"]["hosts"] = {
                "status": "error",
                "error": str(e)
            }

        # Test sites endpoint
        try:
            sites = _get("/sites")
            result["tests"]["sites"] = {
                "status": "ok",
                "count": len(sites.get("data", []))
            }
        except Exception as e:
            result["tests"]["sites"] = {
                "status": "error",
                "error": str(e)
            }

        # Test devices endpoint
        try:
            devices = _get("/devices")
            result["tests"]["devices"] = {
                "status": "ok",
                "count": len(devices.get("data", []))
            }
        except Exception as e:
            result["tests"]["devices"] = {
                "status": "error",
                "error": str(e)
            }

        return result

    # ========= MCP Prompts =========
    @mcp.prompt("network_status")
    def prompt_network_status() -> str:
        """Get a comprehensive network status report"""
        return """Please provide a comprehensive UniFi network status report including:
    1. All hosts (consoles) and their status
    2. All sites configured
    3. All devices - grouped by type (APs, switches, gateways)
    4. Any devices that are offline or having issues
    5. Overall network health assessment"""

    @mcp.prompt("troubleshoot_device")
    def prompt_troubleshoot_device() -> str:
        """Help troubleshoot a device issue"""
        return """I need help troubleshooting a UniFi device. Please:
    1. List all devices and their current status
    2. Identify any devices that are offline or degraded
    3. Provide recommendations for resolving issues"""

    # ========= Main =========
    if __name__ == "__main__":
        print("=" * 60)
        print("UniFi MCP Server - UI.com Cloud API")
        print("=" * 60)
        print(f"API Base: {API_BASE}")
        print(f"API Key: {'configured' if UNIFI_API_KEY else 'NOT SET'}")
        print("=" * 60)

        if not UNIFI_API_KEY:
            print("WARNING: UNIFI_API_KEY not set - API calls will fail!")

        mcp.run()
