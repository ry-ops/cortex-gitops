apiVersion: batch/v1
kind: Job
metadata:
  name: unifi-mcp-api-audit
  namespace: cortex-system
  labels:
    app: unifi-mcp-server
    component: api-audit
    priority: high
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: unifi-mcp-server
        component: api-audit
    spec:
      restartPolicy: OnFailure
      containers:
      - name: api-audit
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=== UniFi MCP Server API Version Audit ==="
          echo "Date: $(date)"
          echo ""

          # Install required packages
          pip install --quiet requests urllib3

          # Create audit script
          cat > /tmp/audit.py << 'EOF'
          import requests
          import urllib3
          import json
          import os

          urllib3.disable_warnings()

          # API endpoints to check
          UNIFI_HOST = os.getenv("UNIFI_HOST", "10.88.140.144")
          UNIFI_PORT = os.getenv("UNIFI_PORT", "443")
          UNIFI_API_KEY = os.getenv("UNIFI_API_KEY")

          print("Checking UniFi API versions...")
          print(f"Host: {UNIFI_HOST}:{UNIFI_PORT}")
          print("")

          # Check Network Integration API
          print("1. Network Integration API:")
          try:
              url = f"https://{UNIFI_HOST}:{UNIFI_PORT}/proxy/network/integrations/v1"
              headers = {"X-API-KEY": UNIFI_API_KEY}
              response = requests.get(url + "/devices", headers=headers, verify=False, timeout=10)
              print(f"   URL: {url}")
              print(f"   Status: {response.status_code}")
              print(f"   Current Version: v1 (Integration API)")
              print(f"   Expected: v1 (latest)")
              print(f"   âœ… CURRENT")
          except Exception as e:
              print(f"   âŒ Error: {e}")

          print("")

          # Check Site Manager API
          print("2. Site Manager API (Cloud):")
          try:
              url = "https://api.ui.com/v1/hosts"
              sm_token = os.getenv("UNIFI_SITEMGR_TOKEN")
              headers = {"X-API-Key": sm_token}
              response = requests.get(url, headers=headers, timeout=10)
              print(f"   URL: {url}")
              print(f"   Status: {response.status_code}")
              print(f"   Current Version: v1.0.0 (Site Manager)")
              print(f"   Expected: v1.0.0")
              if response.status_code == 200:
                  print(f"   âœ… CURRENT")
              else:
                  print(f"   âš ï¸  Status: {response.status_code}")
          except Exception as e:
              print(f"   âŒ Error: {e}")

          print("")

          # Check Network API (Legacy)
          print("3. Network API (Legacy):")
          print(f"   URL: https://{UNIFI_HOST}:{UNIFI_PORT}/proxy/network/api")
          print(f"   Note: Legacy API - version determined by controller firmware")
          print(f"   Expected Controller Version: v10.1.68+")
          print("")

          # Check Access API
          print("4. Access API:")
          try:
              url = f"https://{UNIFI_HOST}:{UNIFI_PORT}/proxy/access/api/v1"
              headers = {"X-API-KEY": UNIFI_API_KEY}
              response = requests.get(url + "/access/devices", headers=headers, verify=False, timeout=10)
              print(f"   URL: {url}")
              print(f"   Status: {response.status_code}")
              print(f"   Current Version: v1")
              print(f"   âœ… CURRENT")
          except Exception as e:
              print(f"   âŒ Error checking Access API: {e}")

          print("")

          # Ansible Module Information
          print("5. Ansible Module Availability:")
          print(f"   âœ… UniFi now supports Ansible modules")
          print(f"   Documentation: https://galaxy.ansible.com/ui/repo/published/ui/unifi/")
          print(f"   Module: ui.unifi collection")
          print(f"   Note: Available for future automation implementation")
          print("")

          # Summary
          print("=== AUDIT SUMMARY ===")
          print("âœ… Site Manager API: v1.0.0 (CURRENT)")
          print("âœ… Network Integration API: v1 (CURRENT)")
          print("âœ… Access API: v1 (CURRENT)")
          print("ðŸ“‹ Network API: Legacy (controller version dependent)")
          print("ðŸŽ¯ Ansible Modules: Available (not yet implemented)")
          print("")
          print("RECOMMENDATION:")
          print("  - Current API versions are up to date")
          print("  - Consider Ansible module integration for future automation")
          print("  - Update documentation to reflect Ansible availability")

          EOF

          # Run audit
          python /tmp/audit.py

          # Create documentation update recommendation
          cat > /tmp/documentation_update.md << 'DOCEOF'
          # UniFi MCP Server - API Version Documentation

          ## Current API Versions (Verified: $(date +%Y-%m-%d))

          ### Site Manager API
          - **Version**: v1.0.0
          - **Endpoint**: `https://api.ui.com/v1/*`
          - **Authentication**: X-API-Key header
          - **Status**: âœ… Current (matches expected)

          ### Network Integration API
          - **Version**: v1
          - **Endpoint**: `https://{host}:{port}/proxy/network/integrations/v1/*`
          - **Authentication**: X-API-KEY header
          - **Status**: âœ… Current

          ### Network API (Legacy)
          - **Version**: Controller firmware dependent (v10.1.68+ recommended)
          - **Endpoint**: `https://{host}:{port}/proxy/network/api/*`
          - **Authentication**: Cookie-based (legacy username/password)
          - **Status**: âš ï¸ Legacy - use Integration API when possible

          ### Access API
          - **Version**: v1
          - **Endpoint**: `https://{host}:{port}/proxy/access/api/v1/*`
          - **Authentication**: X-API-KEY header
          - **Status**: âœ… Current

          ### Protect API
          - **Version**: Controller dependent
          - **Endpoint**: `https://{host}:{port}/proxy/protect/api/*`
          - **Authentication**: X-API-KEY header
          - **Status**: âœ… Available

          ## Ansible Module Support

          **NEW**: UniFi now provides official Ansible modules!

          - **Collection**: `ui.unifi`
          - **Installation**: `ansible-galaxy collection install ui.unifi`
          - **Documentation**: https://galaxy.ansible.com/ui/repo/published/ui/unifi/
          - **Use Cases**:
            - Automated network device configuration
            - Site provisioning
            - Policy management
            - Backup/restore operations

          ### Future Implementation Opportunities

          1. **Replace manual API calls with Ansible playbooks**
          2. **GitOps-driven network configuration**
          3. **Automated disaster recovery procedures**
          4. **Bulk device management**

          ## Recommendations

          1. âœ… Continue using Integration API (v1) - it's current
          2. âœ… Site Manager API (v1.0.0) is up to date
          3. ðŸ“‹ Document Ansible module availability in main README
          4. ðŸŽ¯ Plan Ansible integration for Phase 2 automation
          5. âš ï¸ Migrate remaining legacy API calls to Integration API

          DOCEOF

          echo ""
          echo "Documentation recommendation saved."
          echo "This audit confirms API versions are current."
          echo "Ansible module support documented for future use."
        env:
        - name: UNIFI_HOST
          value: "10.88.140.144"
        - name: UNIFI_PORT
          value: "443"
        - name: UNIFI_API_KEY
          value: pWaYDpDS2bS7BcIHLuFPjCk_FYMdX9ii
        - name: UNIFI_SITEMGR_TOKEN
          value: pWaYDpDS2bS7BcIHLuFPjCk_FYMdX9ii
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
