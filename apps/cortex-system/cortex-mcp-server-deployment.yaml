apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    argocd.argoproj.io/tracking-id: cortex-system:apps/Deployment:cortex-system/cortex-mcp-server
    deployment.kubernetes.io/revision: '8'
    field.cattle.io/publicEndpoints: '[{"addresses":["10.88.145.200"],"port":443,"protocol":"HTTPS","serviceName":"cortex-system:cortex-mcp-server","ingressName":"cortex-system:cortex-mcp-ingress","hostname":"cortex-mcp.ry-ops.dev","path":"/","allNodes":false}]'
  labels:
    app: cortex-mcp-server
    component: mcp-gateway
    version: v1
  name: cortex-mcp-server
  namespace: cortex-system
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: cortex-mcp-server
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/restartedAt: '2026-01-04T18:51:40-06:00'
        prometheus.io/path: /metrics
        prometheus.io/port: '8080'
        prometheus.io/scrape: 'true'
      creationTimestamp: null
      labels:
        app: cortex-mcp-server
        component: mcp-gateway
        version: v1
    spec:
      terminationGracePeriodSeconds: 45
      containers:
      - command:
        - sh
        - -c
        - "set -e\necho \"Starting Cortex MCP Server...\"\n\ncd /app\n\n# Install\
          \ dependencies\necho \"Installing dependencies...\"\nnpm install --production\n\
          \n# Create required directories if they don't exist\nmkdir -p /app/coordination/masters\n\
          mkdir -p /app/coordination/workers\nmkdir -p /app/coordination/tasks\n\n\
          # Create a simple HTTP wrapper and health endpoint\ncat > /app/http-server.cjs\
          \ << 'EOF'\nconst http = require('http');\nconst { spawn } = require('child_process');\n\
          \nconst PORT = parseInt(process.env.MCP_PORT || '3000');\nconst HEALTH_PORT\
          \ = parseInt(process.env.HEALTH_PORT || '8080');\n\n// Start MCP stdio server\
          \ process\nlet mcpProcess = null;\n\nfunction startMCPServer() {\n  mcpProcess\
          \ = spawn('node', ['src/index.js'], {\n    cwd: '/app'\n  });\n\n  mcpProcess.stdout.on('data',\
          \ (data) => {\n    console.log('[MCP stdout]', data.toString());\n  });\n\
          \n  mcpProcess.stderr.on('data', (data) => {\n    console.error('[MCP stderr]',\
          \ data.toString());\n  });\n\n  mcpProcess.on('exit', (code) => {\n    console.error(`[MCP]\
          \ Process exited with code ${code}`);\n    // Restart if it crashes\n  \
          \  setTimeout(startMCPServer, 1000);\n  });\n\n  // Keep stdin open\n  setInterval(()\
          \ => {\n    try {\n      mcpProcess.stdin.write('\\n');\n    } catch (err)\
          \ {\n      // Ignore\n    }\n  }, 30000);\n}\n\n// Health check server\n\
          const healthServer = http.createServer((req, res) => {\n  if (req.url ===\
          \ '/health') {\n    res.writeHead(200, { 'Content-Type': 'application/json'\
          \ });\n    res.end(JSON.stringify({\n      status: 'healthy',\n      server:\
          \ 'cortex-mcp-server',\n      mode: 'stdio-wrapper',\n      mcp_running:\
          \ mcpProcess && !mcpProcess.killed\n    }));\n  } else if (req.url === '/metrics')\
          \ {\n    res.writeHead(200, { 'Content-Type': 'text/plain' });\n    res.end('#\
          \ Cortex MCP Server Metrics\\ncortex_mcp_up 1\\n');\n  } else {\n    res.writeHead(404);\n\
          \    res.end();\n  }\n});\n\nhealthServer.listen(HEALTH_PORT, '0.0.0.0',\
          \ () => {\n  console.log(`[Health] HTTP server listening on port ${HEALTH_PORT}`);\n\
          });\n\n// MCP query server (simple passthrough for now)\nconst mcpServer\
          \ = http.createServer((req, res) => {\n  if (req.url === '/query' && req.method\
          \ === 'POST') {\n    let body = '';\n    req.on('data', chunk => { body\
          \ += chunk; });\n    req.on('end', () => {\n      res.writeHead(200, { 'Content-Type':\
          \ 'application/json' });\n      res.end(JSON.stringify({\n        message:\
          \ 'Cortex MCP Server - stdio mode',\n        note: 'Use stdio protocol to\
          \ interact with MCP server'\n      }));\n    });\n  } else {\n    res.writeHead(404);\n\
          \    res.end();\n  }\n});\n\nmcpServer.listen(PORT, '0.0.0.0', () => {\n\
          \  console.log(`[MCP] HTTP wrapper listening on port ${PORT}`);\n  startMCPServer();\n\
          });\n\nprocess.on('SIGTERM', () => {\n  console.log('[Wrapper] Received\
          \ SIGTERM, shutting down...');\n  if (mcpProcess) mcpProcess.kill();\n \
          \ process.exit(0);\n});\nEOF\n\n# Start the HTTP wrapper\necho \"Starting\
          \ HTTP wrapper...\"\nexec node /app/http-server.cjs\n"
        env:
        - name: UNIFI_MCP_URL
          valueFrom:
            configMapKeyRef:
              key: UNIFI_MCP_URL
              name: cortex-mcp-config
        - name: PROXMOX_MCP_URL
          valueFrom:
            configMapKeyRef:
              key: PROXMOX_MCP_URL
              name: cortex-mcp-config
        - name: SANDFLY_MCP_URL
          valueFrom:
            configMapKeyRef:
              key: SANDFLY_MCP_URL
              name: cortex-mcp-config
        - name: WORKER_POOL_SIZE
          valueFrom:
            configMapKeyRef:
              key: WORKER_POOL_SIZE
              name: cortex-mcp-config
        - name: MAX_CONCURRENT_WORKERS
          valueFrom:
            configMapKeyRef:
              key: MAX_CONCURRENT_WORKERS
              name: cortex-mcp-config
        - name: WORKER_TIMEOUT_MINUTES
          valueFrom:
            configMapKeyRef:
              key: WORKER_TIMEOUT_MINUTES
              name: cortex-mcp-config
        - name: MOE_ENABLED
          valueFrom:
            configMapKeyRef:
              key: MOE_ENABLED
              name: cortex-mcp-config
        - name: MOE_STRATEGY
          valueFrom:
            configMapKeyRef:
              key: MOE_STRATEGY
              name: cortex-mcp-config
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              key: LOG_LEVEL
              name: cortex-mcp-config
        - name: LOG_FORMAT
          valueFrom:
            configMapKeyRef:
              key: LOG_FORMAT
              name: cortex-mcp-config
        - name: MCP_PORT
          valueFrom:
            configMapKeyRef:
              key: MCP_PORT
              name: cortex-mcp-config
        - name: HEALTH_PORT
          valueFrom:
            configMapKeyRef:
              key: HEALTH_PORT
              name: cortex-mcp-config
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              key: NODE_ENV
              name: cortex-mcp-config
        image: node:18-alpine
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: health
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        name: cortex-mcp-server
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - sleep 15
        ports:
        - containerPort: 3000
          name: mcp
          protocol: TCP
        - containerPort: 8080
          name: health
          protocol: TCP
        readinessProbe:
          failureThreshold: 2
          httpGet:
            path: /health
            port: health
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: '1'
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 256Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /app
          name: workspace
        - mountPath: /app/coordination
          name: coordination
        - mountPath: /tmp
          name: tmp
        workingDir: /app
      dnsPolicy: ClusterFirst
      initContainers:
      - command:
        - sh
        - -c
        - 'set -e

          echo "Preparing Cortex MCP Server workspace..."


          # Create directory structure

          mkdir -p /app/src/clients

          mkdir -p /app/src/worker-pool

          mkdir -p /app/src/masters

          mkdir -p /app/src/tools

          mkdir -p /app/config

          mkdir -p /app/coordination/masters

          mkdir -p /app/coordination/workers

          mkdir -p /app/coordination/tasks


          # Copy root files

          echo "Copying root files..."

          cp /source/package.json /app/

          cp /source/Dockerfile /app/


          # Copy src files to correct locations

          echo "Copying src files..."

          cp /source/index.js /app/src/

          cp /source/moe-router.js /app/src/


          # Copy client files

          echo "Copying client files..."

          cp /source/k8s.js /app/src/clients/

          cp /source/proxmox.js /app/src/clients/

          cp /source/unifi.js /app/src/clients/

          cp /source/sandfly.js /app/src/clients/


          # Copy tool files

          echo "Copying tool files..."

          cp /source/query.js /app/src/tools/

          cp /source/status.js /app/src/tools/


          # Copy worker-pool files

          echo "Copying worker-pool files..."

          cp /source/coordinator.js /app/src/worker-pool/

          cp /source/monitor.js /app/src/worker-pool/

          cp /source/spawner.js /app/src/worker-pool/


          # List what we have

          echo "Workspace contents:"

          ls -la /app/

          echo ""

          echo "Source structure:"

          ls -laR /app/src/


          echo "Workspace preparation complete!"

          '
        image: busybox:latest
        imagePullPolicy: Always
        name: prepare-workspace
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /app
          name: workspace
        - mountPath: /source
          name: source
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: cortex-mcp-server
      serviceAccountName: cortex-mcp-server
      volumes:
      - emptyDir: {}
        name: workspace
      - configMap:
          defaultMode: 420
          name: cortex-mcp-src
        name: source
      - emptyDir: {}
        name: coordination
      - emptyDir: {}
        name: tmp
