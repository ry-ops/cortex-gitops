# Vulnerability Remediation Workflow

Chat-driven vulnerability detection and automated remediation for the Cortex infrastructure.

## Overview

The GitHub Security MCP Server enables natural language interaction with Dependabot vulnerability alerts across all `ry-ops` organization repositories. This document describes the end-to-end workflow for detecting, analyzing, and remediating security vulnerabilities via chat interface.

## Architecture

```
┌──────────────────────────────────────────────────────────┐
│                      User (Chat)                         │
│  "Show me vulnerabilities in DriveIQ"                    │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              Cortex MoE Router                           │
│  Routes query based on keywords:                         │
│  vulnerability, cve, dependabot, etc.                    │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│        GitHub Security MCP Server                        │
│  github-security-mcp-server.cortex-system:3003           │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              GitHub API                                  │
│  GET /orgs/ry-ops/dependabot/alerts                      │
│  GET /repos/ry-ops/{repo}/dependabot/alerts              │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│           Formatted Response                             │
│  Vulnerability summary with severity, CVE, package       │
│  and remediation options                                 │
└──────────────────────────────────────────────────────────┘
```

## Automatic Routing

The MoE router automatically routes queries containing these keywords to the GitHub Security server:

- `vulnerability`, `vulnerabilities`, `cve`
- `dependabot`, `security alert`, `github alert`
- `dependency`, `dependencies`, `upgrade`, `patch`
- `security fix`, `remediate`, `remediation`
- `snyk`, `npm audit`, `pip-audit`
- `package vulnerability`, `github security`

**Priority**: 100 (highest priority for security-related queries)

## Common Workflows

### 1. Organization-Wide Vulnerability Scan

**Objective**: Get a high-level overview of all vulnerabilities across the organization.

**User Query**:
```
"Show me all critical vulnerabilities across our organization"
```

**System Response**:
```
Found 8 vulnerabilities:

CRITICAL: 2
HIGH: 3
MEDIUM: 2
LOW: 1

CRITICAL - CVE-2023-12345 (Alert #42)
└─ Package: urllib3 (< 2.0.8)
└─ Improper Handling of Highly Compressed Data
└─ Fix: Upgrade to 2.0.8+

CRITICAL - CVE-2023-23456 (Alert #56)
└─ Package: requests (< 2.31.0)
└─ Server Side Request Forgery
└─ Fix: Upgrade to 2.31.0+

[... more vulnerabilities ...]
```

**Follow-up Actions**:
- "Tell me more about alert #42"
- "Show me vulnerability stats for the organization"
- "List all repositories with vulnerabilities"

---

### 2. Repository-Specific Vulnerability Check

**Objective**: Focus on vulnerabilities in a specific project.

**User Query**:
```
"Show me vulnerabilities in DriveIQ backend"
```

**System Response**:
```
Vulnerabilities in ry-ops/DriveIQ:

Found 3 vulnerabilities:

HIGH: 1
MEDIUM: 2

HIGH - CVE-2023-XXXXX (Alert #15)
└─ Package: urllib3 (2.0.7)
└─ Improper Handling of Highly Compressed Data
└─ Fix: Upgrade to 2.0.8+
└─ File: backend/requirements.txt

MEDIUM - CVE-2022-XXXXX (Alert #18)
└─ Package: torch (1.13.1)
└─ Reachable Assertion
└─ Fix: Upgrade to 2.0.0+
└─ File: backend/requirements.txt

MEDIUM - CVE-2023-YYYYY (Alert #22)
└─ Package: numpy (1.24.0)
└─ Buffer Overflow
└─ Fix: Upgrade to 1.24.3+
└─ File: backend/requirements.txt
```

**Follow-up Actions**:
- "Get details for alert #15"
- "Is there a fix PR for alert #15?"
- "Show me the requirements.txt file"

---

### 3. Detailed Vulnerability Analysis

**Objective**: Understand the full details of a specific vulnerability.

**User Query**:
```
"Tell me more about alert #15 in DriveIQ"
```

**System Response**:
```
Vulnerability Details (Alert #15):

CVE ID: CVE-2023-43804
GHSA ID: GHSA-v845-jxx5-vc9f
Severity: HIGH
CVSS Score: 7.5

Summary: Improper Handling of Highly Compressed Data (Data Amplification Attack)

Description:
urllib3 contains a flaw that allows an attacker to perform a data
amplification attack by sending a specially crafted compressed response.
This can lead to denial of service through CPU and memory exhaustion.

Affected Package:
- Name: urllib3
- Ecosystem: pip
- Vulnerable Range: < 2.0.8
- First Patched Version: 2.0.8

State: open
Created: 2023-10-04T10:00:00Z
Updated: 2023-10-04T10:00:00Z

References:
- https://github.com/urllib3/urllib3/security/advisories/GHSA-v845-jxx5-vc9f
- https://nvd.nist.gov/vuln/detail/CVE-2023-43804
- https://github.com/urllib3/urllib3/commit/abc123def456

Affected Files:
- Package: urllib3
- Manifest: backend/requirements.txt
```

**Follow-up Actions**:
- "Is there a Dependabot PR for this?"
- "Show me the vulnerable file"
- "Create a fix for this vulnerability"

---

### 4. Checking for Automated Fix PRs

**Objective**: See if Dependabot has already created a fix PR.

**User Query**:
```
"Is there a fix PR for alert #15 in DriveIQ?"
```

**System Response (If PR exists)**:
```
Dependabot Fix PR for Alert #15:

PR #123: OPEN
URL: https://github.com/ry-ops/DriveIQ/pull/123

The fix is ready to review and merge.
```

**System Response (If no PR)**:
```
No Dependabot PR found for Alert #15.

Dependabot has not yet created a PR for this vulnerability.
You may need to:
1. Check if auto-updates are enabled for this repo
2. Manually create a PR with the fix
3. Update the dependency in your manifest file
```

**Follow-up Actions**:
- "Review PR #123" (if exists)
- "Create a manual fix PR" (if no PR)
- "Show me the vulnerable file so I can update it"

---

### 5. Manual Remediation Process

**Objective**: Manually fix a vulnerability when Dependabot hasn't created a PR.

**User Query**:
```
"Show me the affected files for alert #15 in DriveIQ"
```

**System Response**:
```
Vulnerable Files for Alert #15:

Package: urllib3
Manifest File: backend/requirements.txt

To view the file:
GET /repos/ry-ops/DriveIQ/contents/backend/requirements.txt
```

**Follow-up Actions**:
1. "Show me the contents of backend/requirements.txt in DriveIQ"
2. Update the file (manually or via another tool)
3. Create a PR with the changes
4. Once merged, verify the alert is resolved

**Manual Fix Example**:
```python
# requirements.txt - Before
urllib3==2.0.7
requests==2.31.0

# requirements.txt - After
urllib3==2.0.8  # Updated to fix CVE-2023-43804
requests==2.31.0
```

---

### 6. Dismissing False Positives

**Objective**: Dismiss vulnerabilities that don't apply to your use case.

**User Query**:
```
"Dismiss alert #22 in DriveIQ as not used"
```

**System Response**:
```
Alert #22 dismissed successfully.

Reason: not_used
Comment: This vulnerability doesn't apply to our use case

State: dismissed
Dismissed By: automation
Dismissed At: 2026-01-12T10:30:00Z
```

**Dismiss Reasons**:
- `fix_started` - Fix is in progress
- `inaccurate` - False positive
- `no_bandwidth` - Won't fix right now
- `not_used` - Vulnerable code not used in our application
- `tolerable_risk` - Accepted risk (document why)

**Best Practices**:
- Always include a comment explaining why
- Document accepted risks for audit purposes
- Regularly review dismissed alerts

---

### 7. Organization Statistics and Reporting

**Objective**: Get vulnerability metrics for security reporting.

**User Query**:
```
"Show me vulnerability statistics for our organization"
```

**System Response**:
```
Vulnerability Statistics for ry-ops:

TOTAL OPEN VULNERABILITIES: 42

By Severity:
- Critical: 5
- High: 12
- Medium: 18
- Low: 7

By Ecosystem:
- pip: 18
- npm: 15
- rubygems: 5
- go: 4

Top Affected Repositories:
- DriveIQ: 8 vulnerabilities
- cortex-platform: 6 vulnerabilities
- mobile-app: 5 vulnerabilities
- api-gateway: 4 vulnerabilities
- data-pipeline: 3 vulnerabilities
```

**Use Cases**:
- Security team reporting
- Sprint planning (prioritize high-severity fixes)
- Compliance audits
- Tracking remediation progress over time

---

## Advanced Workflows

### Batch Analysis

**Query**: "List all repositories with open vulnerabilities"

This helps identify which projects need attention.

### Ecosystem-Specific Scans

**Query**: "Show me all npm vulnerabilities"

Filter by package ecosystem (npm, pip, rubygems, go, etc.)

### Severity-Based Prioritization

**Query**: "Show me all critical and high severity vulnerabilities"

Focus on the most urgent issues first.

---

## Integration with Development Workflow

### 1. Pre-Sprint Planning
```
User: "Show me vulnerability stats"
→ Review critical/high severity issues
→ Add fixes to sprint backlog
```

### 2. During Development
```
User: "Show me vulnerabilities in [current-project]"
→ Review before merging
→ Fix vulnerabilities in the same PR
```

### 3. CI/CD Integration (Future)
```
→ Automated scans on PR creation
→ Block merge if critical vulnerabilities introduced
→ Auto-create fix PRs via Dependabot
```

### 4. Security Review Meetings
```
User: "Show me vulnerability stats for the organization"
→ Track metrics over time
→ Report to stakeholders
→ Identify systemic issues
```

---

## Best Practices

### 1. Regular Scanning
- Check organization-wide vulnerabilities weekly
- Review critical/high severity alerts immediately
- Set up alerts for new critical vulnerabilities (future enhancement)

### 2. Prioritization Matrix
```
CRITICAL + Production → Fix immediately
CRITICAL + Development → Fix within 24 hours
HIGH + Production → Fix within 1 week
HIGH + Development → Fix within 2 weeks
MEDIUM → Fix within 1 month
LOW → Fix when convenient
```

### 3. Response Process
1. **Detect**: Regular vulnerability scans
2. **Analyze**: Review CVE details and impact
3. **Plan**: Determine fix approach (auto PR vs manual)
4. **Fix**: Update dependencies or apply patches
5. **Verify**: Confirm vulnerability resolved
6. **Document**: Record decision for dismissed alerts

### 4. Documentation
- Always add comments when dismissing alerts
- Document why certain dependencies can't be upgraded
- Track accepted risks in security log
- Maintain remediation runbook for common issues

### 5. Team Communication
- Alert team leads about critical vulnerabilities
- Include security fixes in PR descriptions
- Share vulnerability stats in team meetings
- Celebrate when vulnerability count goes down

---

## Troubleshooting

### "No vulnerabilities found" but Dependabot shows alerts

**Possible causes**:
- GitHub token lacks `security_events` scope
- Alerts are in `dismissed` or `fixed` state
- Repository is not in `ry-ops` organization

**Solution**: Check token permissions and query state filters.

---

### API rate limit exceeded

**Symptom**: `403 Forbidden` or rate limit error

**Solution**:
- GitHub allows 5,000 API requests/hour for authenticated users
- Wait for rate limit reset
- Reduce query frequency
- Consider caching results (future enhancement)

---

### ConfigMaps not found

**Symptom**: Deployment fails with "ConfigMap not found" error

**Solution**:
```bash
# Create ConfigMaps from source files
cd ~/Projects/cortex-platform/services/mcp-servers/github-security

kubectl create configmap github-security-mcp-server-py \
  --from-file=server.py=src/mcp_github_security/server.py \
  -n cortex-system

kubectl create configmap github-security-mcp-init-py \
  --from-file=__init__.py=src/mcp_github_security/__init__.py \
  -n cortex-system
```

---

### Server not responding

**Check server health**:
```bash
kubectl get pods -n cortex-system | grep github-security
kubectl logs -n cortex-system deployment/github-security-mcp-server
kubectl describe pod -n cortex-system -l app=github-security-mcp-server
```

**Common issues**:
- Missing or invalid GitHub token
- Network policy blocking GitHub API access
- Resource limits too low (increase memory/CPU)

---

## Future Enhancements

### Automated Remediation
- **Auto-create PRs**: Generate fix PRs directly from chat
- **Batch operations**: Fix multiple vulnerabilities at once
- **Smart updates**: Test fixes in CI before creating PR

### Proactive Monitoring
- **Webhooks**: Real-time alerts for new vulnerabilities
- **Scheduled reports**: Daily/weekly vulnerability digests
- **Trend analysis**: Track vulnerability metrics over time

### Advanced Features
- **SBOM generation**: Software Bill of Materials for each repo
- **Custom policies**: Define organization-specific rules
- **Integration with Jira**: Auto-create tickets for vulnerabilities
- **Slack notifications**: Alert team channels for critical issues

### AI-Powered Analysis
- **Impact assessment**: Determine if vulnerable code is reachable
- **Auto-triage**: Suggest dismiss reasons based on code analysis
- **Remediation templates**: Common fix patterns for known CVEs

---

## Security Considerations

### Token Security
- **Scope**: Token has read/write access to security events
- **Storage**: Currently environment variable (consider Kubernetes Secrets)
- **Rotation**: Rotate token regularly (every 90 days)
- **Audit**: Monitor token usage via GitHub audit log

### Access Control
- **RBAC**: MCP server runs with cluster-level permissions
- **Network Policy**: Restrict access to GitHub API endpoints
- **Audit Trail**: All operations logged in server logs

### Data Privacy
- **No data storage**: Server doesn't persist vulnerability data
- **API calls only**: All data fetched on-demand from GitHub
- **Logs**: Sensitive data sanitized from logs

---

## Maintenance

### Daily
- Monitor server health
- Check for new critical vulnerabilities

### Weekly
- Review vulnerability statistics
- Fix critical and high severity issues
- Update dismissed alerts if needed

### Monthly
- Rotate GitHub API token
- Review and update network policies
- Audit dismissed vulnerabilities
- Update server dependencies

### Quarterly
- Security review of the MCP server itself
- Update documentation
- Review and improve workflow processes

---

## Getting Help

### Resources
- **GitHub Dependabot Docs**: https://docs.github.com/en/code-security/dependabot
- **GitHub API Docs**: https://docs.github.com/en/rest/dependabot/alerts
- **Server README**: `/Users/ryandahlberg/Projects/cortex-platform/services/mcp-servers/github-security/README.md`

### Support Channels
- **Server Logs**: `kubectl logs -n cortex-system deployment/github-security-mcp-server`
- **GitHub Status**: https://www.githubstatus.com/
- **Internal Docs**: This file and server README

### Contact
- **Infrastructure Team**: For deployment issues
- **Security Team**: For vulnerability triage and policy questions
- **Development Teams**: For repository-specific remediation

---

## Appendix: Example Chat Sessions

### Session 1: Daily Security Check
```
User: "Show me vulnerability stats"

System: [Stats showing 42 open vulnerabilities]

User: "Show me all critical vulnerabilities"

System: [5 critical vulnerabilities listed]

User: "Tell me more about alert #42"

System: [Detailed CVE information]

User: "Is there a fix PR for alert #42?"

System: "PR #123 is ready to merge"

User: "Great, I'll review and merge it"
```

### Session 2: New Project Review
```
User: "Show me vulnerabilities in the new mobile-app repo"

System: [15 vulnerabilities found]

User: "Show me only critical and high severity"

System: [4 critical/high vulnerabilities]

User: "For each one, check if there's a fix PR"

System: [3 have PRs, 1 needs manual fix]

User: "I'll merge the PRs and fix the last one manually"
```

### Session 3: False Positive Handling
```
User: "Show me vulnerabilities in api-gateway"

System: [Alert #56 about ReDoS in regex library]

User: "Tell me more about alert #56"

System: [Details about regex vulnerability]

User: "We don't use that regex feature. Dismiss as not used"

System: "Alert #56 dismissed successfully"
```

---

**Document Version**: 1.0.0
**Last Updated**: 2026-01-12
**Maintained By**: Cortex Infrastructure Team
